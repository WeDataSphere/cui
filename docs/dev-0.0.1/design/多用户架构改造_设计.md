# CUIå¤šç”¨æˆ·æ¶æ„æ”¹é€  - è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **æœ€åæ›´æ–°**: 2025-12-11
- **ç»´æŠ¤äºº**: Claude Agent
- **æ–‡æ¡£çŠ¶æ€**: å·²æ‰¹å‡†
- **éœ€æ±‚ç±»å‹**: REFACTORï¼ˆæ¶æ„é‡æ„ï¼‰
- **éœ€æ±‚æ–‡æ¡£**: [å¤šç”¨æˆ·æ¶æ„æ”¹é€ _éœ€æ±‚.md](../requirements/å¤šç”¨æˆ·æ¶æ„æ”¹é€ _éœ€æ±‚.md)

---

## æ‰§è¡Œæ‘˜è¦

> ğŸ“– **é˜…è¯»æŒ‡å¼•**ï¼šæœ¬ç« èŠ‚ä¸º1é¡µæ¦‚è§ˆï¼ˆçº¦500å­—ï¼‰ï¼Œç”¨äºå¿«é€Ÿç†è§£è®¾è®¡æ–¹æ¡ˆã€‚è¯¦ç»†å†…å®¹è¯·å‚è€ƒåç»­ç« èŠ‚ã€‚

### è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æè¿° | ä¼˜å…ˆçº§ |
|-----|------|-------|
| ç”¨æˆ·éš”ç¦» | å®ç°æ¯ä¸ªç”¨æˆ·çš„é…ç½®ã€ä¼šè¯ã€å·¥ä½œåŒºå®Œå…¨éš”ç¦» | P0 |
| è¿›ç¨‹éš”ç¦» | ä½¿ç”¨ `sudo -u <username>` åˆ‡æ¢ç”¨æˆ·èº«ä»½è¿è¡Œ Claude CLI | P0 |
| è®¤è¯é›†æˆ | é€šè¿‡ä¼ä¸šç½‘å…³çš„ Token + Cookie å®ç°ç”¨æˆ·èº«ä»½è¯†åˆ« | P0 |
| å¯æ‰©å±•æ€§ | æ”¯æŒ 2000 æ€»ç”¨æˆ·æ•°ï¼Œ200-500 å¹¶å‘ç”¨æˆ· | P0 |
| æ•°æ®å®‰å…¨ | å®ç°æ•°æ®åº“ user_id éš”ç¦»ã€æ–‡ä»¶ç³»ç»Ÿæƒé™éš”ç¦» | P0 |

### æ ¸å¿ƒè®¾è®¡å†³ç­–

| å†³ç­–ç‚¹ | é€‰æ‹©æ–¹æ¡ˆ | å†³ç­–ç†ç”±ï¼ˆä¸€å¥è¯ï¼‰ | æ›¿ä»£æ–¹æ¡ˆ |
|-------|---------|------------------|---------|
| é‡æ„ç­–ç•¥ | æ¸è¿›å¼å¼€å‘ï¼ˆ6ä¸ªé˜¶æ®µï¼‰ | é£é™©å¯æ§ï¼Œæ¯ä¸ªé˜¶æ®µç‹¬ç«‹éªŒè¯ | å¤§çˆ†ç‚¸å¼€å‘ï¼ˆé£é™©é«˜ï¼‰ |
| æ•°æ®åº“ | MySQL 8.0 | æ”¯æŒå¤šç”¨æˆ·å¹¶å‘å†™å…¥ï¼Œä¼ä¸šçº§éƒ¨ç½² | PostgreSQLï¼ˆåŠŸèƒ½å¼ºï¼Œå­¦ä¹ æˆæœ¬ç¨é«˜ï¼‰ |
| è®¤è¯æ–¹æ¡ˆ | ç½‘å…³ç»Ÿä¸€è®¤è¯ï¼ˆToken+Cookieï¼‰ | é›†æˆç®€å•ï¼Œå¤ç”¨ä¼ä¸šç½‘å…³æŠ•èµ„ | è‡ªç ”JWT/LDAPï¼ˆå¤æ‚åº¦é«˜ï¼‰ |
| è¿›ç¨‹éš”ç¦» | sudo -u <username> åˆ‡æ¢ç”¨æˆ· | åˆ©ç”¨ Linux æƒé™æ¨¡å‹ï¼Œéš”ç¦»å½»åº• | Docker å®¹å™¨ï¼ˆå¼€é”€å¤§ï¼‰ |
| æ–‡ä»¶å­˜å‚¨ | ç”¨æˆ·ç›®å½•æ˜ å°„åˆ° `/mnt/bdap/<username>/` | ç¬¦åˆä¼ä¸šè¿ç»´è§„èŒƒï¼Œæ”¯æŒæƒé™ç®¡ç† | è™šæ‹Ÿè·¯å¾„æ˜ å°„ï¼ˆç®¡ç†å¤æ‚ï¼‰ |
| éƒ¨ç½²ç­–ç•¥ | æ–°ç¯å¢ƒå…¨æ–°éƒ¨ç½² | ç‹¬ç«‹ç¯å¢ƒï¼Œæ— å†å²åŒ…è¢±ï¼Œé£é™©ä½ | åŸåœ°å‡çº§ï¼ˆé£é™©é«˜ï¼Œéœ€è¿ç§»ï¼‰ |

### æ¶æ„æ¦‚è§ˆå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‰ç«¯åº”ç”¨ï¼ˆReactï¼‰                        â”‚
â”‚                   + ç½‘å…³è®¤è¯ï¼ˆSSOï¼‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Token + Cookie (user context)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   CUI Server (Node.js)    â”‚
        â”‚                          â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚ â”‚ è®¤è¯ä¸­é—´ä»¶           â”‚ â”‚  éªŒè¯Token & Cookie
        â”‚ â”‚ gatewayAuthMiddlewareâ”‚ â”‚  æ³¨å…¥ req.user ä¸Šä¸‹æ–‡
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚          â”‚               â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚ â”‚ API è·¯ç”±ï¼ˆæŒ‰ç”¨æˆ·ï¼‰  â”‚  â”‚  /api/conversations
        â”‚ â”‚ ç”¨æˆ·éš”ç¦»å¤„ç†        â”‚  â”‚  /api/users/me
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚          â”‚               â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚ ProcessManager (sudo -u user)  â”‚  â† æ ¸å¿ƒï¼šè¿›ç¨‹éš”ç¦»
        â”‚ â”‚ ConfigService (user config)    â”‚  â† ç”¨æˆ·çº§é…ç½®
        â”‚ â”‚ SessionInfoService (user_id)   â”‚  â† ä¼šè¯éš”ç¦»
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚          â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ â”‚ Claude CLI (Linux)   â”‚  ä»¥çœŸå®ç”¨æˆ·èº«ä»½è¿è¡Œ
        â”‚ â”‚ euid = çœŸå®ç”¨æˆ·ID    â”‚  è®¿é—®ç”¨æˆ·ç›®å½•
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL DB  â”‚ â”‚ User Dirs    â”‚ â”‚ Audit Logs     â”‚
â”‚ user_id    â”‚ â”‚ /mnt/bdap/   â”‚ â”‚ .cui/logs/     â”‚
â”‚ isolation  â”‚ â”‚ <username>/  â”‚ â”‚ <username>/    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®é£é™©ä¸ç¼“è§£

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| Sudo æƒé™é…ç½®é”™è¯¯ | é«˜ | è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬ + å……åˆ†æµ‹è¯• + é™çº§æ–¹æ¡ˆ |
| ç½‘å…³é›†æˆé—®é¢˜ | é«˜ | ä¸ç½‘å…³å›¢é˜Ÿæå‰å¯¹æ¥ + æ¨¡æ‹Ÿæµ‹è¯• + æœ¬åœ°è®¤è¯é™çº§ |
| è¿›ç¨‹æ³„éœ²èµ„æºè€—å°½ | ä¸­ | è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç† + ç›‘æ§å‘Šè­¦ + ulimit é™åˆ¶ |
| å›¢é˜Ÿä¸ç†Ÿæ‚‰æ–°æ¶æ„ | ä¸­ | æŠ€æœ¯åˆ†äº« + è¯¦ç»†æ–‡æ¡£ + ä»£ç ç¤ºä¾‹æ³¨é‡Š |

### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|-----|-------|------|
| å¹¶å‘ç”¨æˆ·æ•° | 200-500 | å‹æµ‹éªŒè¯ |
| æ€»ç”¨æˆ·æ•° | 2000 | æ•°æ®åº“å®¹é‡éªŒè¯ |
| ç”¨æˆ·éš”ç¦»ç¨‹åº¦ | 100% | å®Œå…¨éš”ç¦»ï¼Œæ— äº¤å‰æ±¡æŸ“ |
| è¿›ç¨‹éš”ç¦»ç¨‹åº¦ | 100% | euid ä¸ºçœŸå®ç”¨æˆ· |
| å›æ”¶ä¸è¯¯æ”¶ | 99.9% | å¿ƒè·³æœºåˆ¶é˜²è¯¯å›æ”¶ |

### ç« èŠ‚å¯¼èˆª

| å…³æ³¨ç‚¹ | æ¨èç« èŠ‚ |
|-------|---------|
| æƒ³äº†è§£æ•´ä½“æ¶æ„ | [1.1 ç³»ç»Ÿæ¶æ„è®¾è®¡](#11-ç³»ç»Ÿæ¶æ„è®¾è®¡) |
| æƒ³äº†è§£å¼€å‘é˜¶æ®µ | [1.2 æ¸è¿›å¼å¼€å‘è®¡åˆ’](#12-æ¸è¿›å¼å¼€å‘è®¡åˆ’) |
| æƒ³äº†è§£æ ¸å¿ƒæµç¨‹ | [1.3 æ ¸å¿ƒæµç¨‹è®¾è®¡](#13-æ ¸å¿ƒæµç¨‹è®¾è®¡) |
| æƒ³äº†è§£è¿›ç¨‹éš”ç¦» | [1.4 è¿›ç¨‹éš”ç¦»å®ç°](#14-è¿›ç¨‹éš”ç¦»å®ç°) |
| æƒ³äº†è§£æ•°æ®æ¨¡å‹ | [2.1 æ•°æ®æ¨¡å‹è®¾è®¡](#21-æ•°æ®æ¨¡å‹è®¾è®¡) |
| æƒ³äº†è§£APIè§„èŒƒ | [2.2 APIè§„èŒƒè®¾è®¡](#22-apiè§„èŒƒè®¾è®¡) |
| æƒ³äº†è§£æµ‹è¯•æ–¹æ¡ˆ | [2.4 æµ‹è¯•ç­–ç•¥](#24-æµ‹è¯•ç­–ç•¥) |
| æƒ³æŸ¥çœ‹å®Œæ•´ä»£ç  | [3.2 å®Œæ•´ä»£ç ç¤ºä¾‹](#32-å®Œæ•´ä»£ç ç¤ºä¾‹) |

---

# Part 1: æ ¸å¿ƒè®¾è®¡

> ğŸ¯ **æœ¬å±‚ç›®æ ‡**ï¼šé˜è¿°æ¶æ„å†³ç­–ã€æ ¸å¿ƒæµç¨‹ã€å…³é”®æ¥å£ï¼Œå®Œæ•´è¯¦ç»†å±•å¼€ã€‚
>
> **é¢„è®¡é˜…è¯»æ—¶é—´**ï¼š10-15åˆ†é’Ÿ

## 1.1 ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1.1.1 ç›®æ ‡æ¶æ„æ¦‚è¿°

**ä»å•ç”¨æˆ·åˆ°å¤šç”¨æˆ·çš„æ ¸å¿ƒå˜æ›´**ï¼š

```
å½“å‰æ¶æ„ï¼ˆå•ç”¨æˆ·ï¼‰              ç›®æ ‡æ¶æ„ï¼ˆå¤šç”¨æˆ·ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ConfigService (å…¨å±€)    â†’        ConfigService (ç”¨æˆ·çº§)
  è¯»å–ï¼š~/.cui/*                  è¯»å–ï¼š/mnt/bdap/<user>/.cui/*

ClaudeProcessManager    â†’        ClaudeProcessManager (éš”ç¦»)
  å¯åŠ¨è¿›ç¨‹ï¼šhadoopèº«ä»½              å¯åŠ¨è¿›ç¨‹ï¼šsudo -u <user>

SessionInfoService      â†’        SessionInfoService (éš”ç¦»)
  å…¨å±€å­˜å‚¨                        æŒ‰user_idæŸ¥è¯¢è¿‡æ»¤

æ— è®¤è¯                  â†’        gatewayAuthMiddleware
                                 Token + Cookie è®¤è¯

SQLite (å•æœº)           â†’        MySQL (å¤šç”¨æˆ·å¹¶å‘)
  æ— user_idéš”ç¦»                   user_id éš”ç¦»ï¼Œç´¢å¼•ä¼˜åŒ–

æ— æƒé™æ§åˆ¶              â†’        Linuxæƒé™ + åº”ç”¨çº§éš”ç¦»
                                 700æƒé™ + è·¯å¾„éªŒè¯
```

### 1.1.2 æ¨¡å—åˆ’åˆ†

| æ¨¡å— | èŒè´£ | å¯¹å¤–æ¥å£ | ä¾èµ– |
|-----|------|---------|------|
| **gatewayAuthMiddleware** | Token & CookieéªŒè¯ï¼Œæ³¨å…¥req.user | req.user={username, homeDir, ...} | æ—  |
| **UserMappingService** | è¯»å–ç³»ç»Ÿç”¨æˆ·ï¼ŒéªŒè¯ç”¨æˆ·ç›®å½•å­˜åœ¨ | getUserMapping(username) | Linux getent |
| **ConfigService(å¢å¼º)** | åŠ è½½ç”¨æˆ·çº§é…ç½®ï¼Œç¼“å­˜ç®¡ç† | loadUserConfig(username) | UserMappingService |
| **ClaudeProcessManager(å¢å¼º)** | ä»¥sudo-uåˆ‡æ¢ç”¨æˆ·å¯åŠ¨è¿›ç¨‹ | startConversation(config+userContext) | ConfigService, UserMappingService |
| **SessionInfoService(å¢å¼º)** | ä¼šè¯å­˜å‚¨ï¼ŒæŒ‰user_idéš”ç¦» | getSessionsByUser(userId) | MySQL |
| **ProcessLifecycleManager(æ–°å¢)** | ç©ºé—²å›æ”¶ã€LRUæ·˜æ±°ã€å¿ƒè·³ç®¡ç† | terminateIdleProcess() | ClaudeProcessManager |
| **AuditLogger(æ–°å¢)** | è®°å½•ç”¨æˆ·æ“ä½œï¼Œæ»¡è¶³åˆè§„ | logOperation(user, action) | MySQL |
| **RateLimitMiddleware(æ–°å¢)** | å•ç”¨æˆ·APIè¯·æ±‚é™æµ | checkRateLimit(userId) | Redis (å¯é€‰) |

### 1.1.3 æŠ€æœ¯é€‰å‹ä¸å¯¹æ¯”

| ç»´åº¦ | é€‰å‹ | ç‰ˆæœ¬ | ç†ç”± |
|-----|------|------|------|
| æ•°æ®åº“ | MySQL | 8.0+ | æˆç†Ÿã€ä¼ä¸šæ ‡å‡†ã€æ”¯æŒå¤šç”¨æˆ·å¹¶å‘å†™å…¥ |
| è®¤è¯ | ç½‘å…³Token+Cookie | N/A | é›†æˆç®€å•ã€å¤ç”¨ä¼ä¸šæŠ•èµ„ã€æ— éœ€è‡ªç ” |
| è¿›ç¨‹éš”ç¦» | sudo -u <user> | Linux native | åˆ©ç”¨Linuxæƒé™æ¨¡å‹ã€éš”ç¦»å½»åº•ã€å¯é  |
| é…ç½®ç®¡ç† | ç”¨æˆ·ç›®å½•æ˜ å°„ | ä¼ä¸šè§„èŒƒ | ç¬¦åˆè¿ç»´è§„èŒƒã€æ”¯æŒæƒé™ç®¡ç† |

---

## 1.2 æ¸è¿›å¼å¼€å‘è®¡åˆ’

**æ€»ä½“æ—¶é—´çº¿**ï¼š1.5-2.5ä¸ªæœˆï¼ˆ7-11å‘¨ï¼‰

```mermaid
gantt
    title CUI å¤šç”¨æˆ·æ¶æ„æ”¹é€  - è¿ç§»è®¡åˆ’
    dateFormat  YYYY-MM-DD

    section é˜¶æ®µ1
    æ•°æ®åº“+è®¤è¯      :a1, 2025-12-15, 10d
    éªŒè¯&æµ‹è¯•        :crit, a1e, after a1, 5d

    section é˜¶æ®µ2
    Claudeè¿›ç¨‹æ”¹é€    :b1, after a1e, 14d
    éªŒè¯&ä¿®å¤        :crit, b1e, after b1, 5d

    section é˜¶æ®µ3
    APIè·¯ç”±æ”¹é€       :c1, after b1e, 7d
    é›†æˆæµ‹è¯•         :crit, c1e, after c1, 3d

    section é˜¶æ®µ4
    å®‰å…¨+èµ„æºç®¡ç†    :d1, after c1e, 14d
    å®‰å…¨æµ‹è¯•         :crit, d1e, after d1, 5d

    section é˜¶æ®µ5
    å‰ç«¯+æ–‡æ¡£        :e1, after d1e, 7d

    section é˜¶æ®µ6
    éƒ¨ç½²ä¸Šçº¿         :f1, after e1, 7d
```

**å…³é”®è·¯å¾„**ï¼šé˜¶æ®µ1 â†’ é˜¶æ®µ2 â†’ é˜¶æ®µ3 â†’ é˜¶æ®µ6ï¼ˆä¸²è¡Œï¼‰
**å¹¶è¡Œä»»åŠ¡**ï¼šé˜¶æ®µ4-5 å¯ä¸é˜¶æ®µ3 éƒ¨åˆ†å¹¶è¡Œ

### é˜¶æ®µ1ï¼šåŸºç¡€æ¶æ„æ”¹é€ ï¼ˆ1-2å‘¨ï¼‰ã€P0ã€‘

**ç›®æ ‡**ï¼šå»ºç«‹å¤šç”¨æˆ·åŸºç¡€æ¡†æ¶ï¼ŒéªŒè¯ç½‘å…³è®¤è¯

**æ ¸å¿ƒæ”¹é€ **ï¼š

1. **æ•°æ®åº“è®¾è®¡ä¸å®ç°**ï¼ˆMySQLï¼‰
   - åˆ›å»º `users`ã€`sessions`ã€`audit_logs` è¡¨
   - è®¾è®¡ `user_id` å­—æ®µå’Œè¡¨å…³ç³»
   - åˆ›å»ºç´¢å¼•ä»¥æ”¯æŒå¤šç”¨æˆ·æŸ¥è¯¢

2. **è®¤è¯ä¸­é—´ä»¶**ï¼ˆ`gatewayAuthMiddleware`ï¼‰
   - éªŒè¯ Header: `X-Gateway-Token`
   - è¯»å– Cookie: `dss_user_name`
   - éªŒè¯ç”¨æˆ·åæ ¼å¼ï¼Œé˜²è·¯å¾„æ³¨å…¥
   - éªŒè¯ç”¨æˆ·ç›®å½•å­˜åœ¨ï¼ˆ`/mnt/bdap/<username>/`ï¼‰
   - æ³¨å…¥ `req.user` ä¸Šä¸‹æ–‡

3. **ç”¨æˆ·æ˜ å°„æœåŠ¡**ï¼ˆ`UserMappingService`ï¼‰
   - è¯»å–ç³»ç»Ÿç”¨æˆ·ä¿¡æ¯ï¼ˆ`getent passwd`ï¼‰
   - éªŒè¯ç”¨æˆ·ç›®å½•æ˜ å°„
   - è¿”å› HOMEã€workspaceã€.claudeã€.cui ç­‰è·¯å¾„

4. **ç”¨æˆ·æ•°æ®åº“æœåŠ¡**ï¼ˆ`UserService`ï¼‰
   - æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
   - æ›´æ–°ç”¨æˆ·åå¥½
   - é…é¢æŸ¥è¯¢ä¸é™åˆ¶

**éªŒæ”¶æ ‡å‡†**ï¼š
- MySQL è¡¨åˆ›å»ºæˆåŠŸï¼Œå¯æ‰§è¡Œå¤šç”¨æˆ·æŸ¥è¯¢
- ç½‘å…³è®¤è¯ä¸­é—´ä»¶é€šè¿‡å•å…ƒæµ‹è¯•
- ç”¨æˆ·ä¸Šä¸‹æ–‡æ­£ç¡®æ³¨å…¥åˆ° `req.user`
- ç”¨æˆ·ç›®å½•éªŒè¯æ— å‡é˜³æ€§

**é£é™©ç­‰çº§**ï¼šä½

---

### é˜¶æ®µ2ï¼šClaude CLI å¤šç”¨æˆ·æ”¹é€ ï¼ˆ2-3å‘¨ï¼‰ã€P0ã€‘

**ç›®æ ‡**ï¼šå®ç° Claude CLI è¿›ç¨‹å’Œé…ç½®çš„ç”¨æˆ·éš”ç¦»

**æ ¸å¿ƒæ”¹é€ **ï¼š

1. **ConfigService å¤šç”¨æˆ·åŒ–**
   ```typescript
   // æ‰©å±• ConversationConfig ç±»å‹
   interface MultiUserConversationConfig extends ConversationConfig {
     userContext: {
       username: string;           // zhangsan, lisi
       homeDir: string;            // /mnt/bdap/zhangsan
       workspaceDir: string;       // /mnt/bdap/zhangsan/workspace
       claudeDir: string;          // /mnt/bdap/zhangsan/.claude
       cuiDir: string;             // /mnt/bdap/zhangsan/.cui
     };
   }
   ```
   - æ–°å¢ `loadUserConfig(username, userCuiDir)` æ–¹æ³•
   - é…ç½®è¯»å–è·¯å¾„ï¼š`/mnt/bdap/<username>/.cui/config.json`
   - ç»´æŠ¤ `Map<username, CUIConfig>` ç”¨æˆ·é…ç½®ç¼“å­˜

2. **ClaudeProcessManager è¿›ç¨‹éš”ç¦»**ï¼ˆâ­ æ ¸å¿ƒï¼‰
   ```typescript
   // å…³é”®æ”¹é€ ï¼šä½¿ç”¨ sudo -u <username> åˆ‡æ¢ç”¨æˆ·
   const proc = spawn('sudo', [
     '-u', username,
     '-i',                          // åŠ è½½ç”¨æˆ·ç¯å¢ƒå˜é‡
     '--',
     'claude',
     ...args
   ], {
     cwd: userContext.workspaceDir,
     // å…³é”®ï¼šè¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ·ï¼ˆeuidï¼‰= çœŸå®ç”¨æˆ·
     // è¿›ç¨‹åªèƒ½è®¿é—®ç”¨æˆ·è‡ªå·±çš„æ–‡ä»¶ï¼ˆLinuxæƒé™æ§åˆ¶ï¼‰
   });
   ```
   - æƒé™éš”ç¦»æœºåˆ¶ï¼š
     - CUI Server ä»¥ `hadoop` ç”¨æˆ·è¿è¡Œï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰
     - å¯åŠ¨ Claude CLI æ—¶åˆ‡æ¢åˆ°çœŸå®ç”¨æˆ·
     - è¿›ç¨‹ euid = çœŸå®ç”¨æˆ·ï¼ˆé hadoopï¼‰
   - æ”¯æŒå¤šå¹¶å‘ç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹è¿›ç¨‹

3. **ClaudeHistoryReader å†å²éš”ç¦»**
   - ä¿®æ”¹å†å²è¯»å–è·¯å¾„ï¼š`/mnt/bdap/<username>/.claude/projects/`
   - æŒ‰ç”¨æˆ·éš”ç¦»ä¼šè¯å†å²æ–‡ä»¶

4. **SessionInfoService ä¼šè¯éš”ç¦»**
   - ä¼šè¯æŸ¥è¯¢æ·»åŠ  `WHERE user_id = ?` è¿‡æ»¤
   - ä¼šè¯åˆ›å»ºæ—¶è®°å½• `user_id`

**éªŒæ”¶æ ‡å‡†**ï¼š
- ä¸åŒç”¨æˆ·çš„ Claude CLI ä½¿ç”¨å„è‡ªçš„ HOME ç›®å½•
- è¿›ç¨‹ euid æ˜¯çœŸå®ç”¨æˆ·ï¼ŒéªŒè¯ `ps -eo pid,euid,cmd`
- ç”¨æˆ· A æ— æ³•è®¿é—®ç”¨æˆ· B çš„æ–‡ä»¶ï¼ˆæƒé™æ‹’ç»ï¼‰
- ä¼šè¯å†å²æŒ‰ç”¨æˆ·éš”ç¦»ï¼Œæ— äº¤å‰æ±¡æŸ“
- é…ç½®åŠ è½½è·¯å¾„æ­£ç¡®

**é£é™©ç­‰çº§**ï¼šä¸­ï¼ˆè¿›ç¨‹éš”ç¦»å…³é”®ï¼Œéœ€è¦å……åˆ†æµ‹è¯•ï¼‰

---

### é˜¶æ®µ3ï¼šè·¯ç”±å’Œ API æ”¹é€ ï¼ˆ1å‘¨ï¼‰ã€P0ã€‘

**ç›®æ ‡**ï¼šæ‰€æœ‰ API æ”¯æŒç½‘å…³è®¤è¯å’Œç”¨æˆ·ä¸Šä¸‹æ–‡

**æ ¸å¿ƒæ”¹é€ **ï¼š

1. **è®¤è¯ä¸­é—´ä»¶åº”ç”¨**
   - æ‰€æœ‰ `/api/*` è·¯ç”±åº”ç”¨ `gatewayAuthMiddleware`
   - `/health`ã€`/metrics` ç­‰å…¬å¼€æ¥å£è±å…

2. **ç”¨æˆ·è·¯ç”±æ–°å¢**
   ```
   GET    /api/users/me              è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
   PATCH  /api/users/me/preferences  æ›´æ–°ç”¨æˆ·åå¥½
   GET    /api/users/me/quota        æŸ¥è¯¢é…é¢ä½¿ç”¨
   ```

3. **ç°æœ‰è·¯ç”±æ”¹é€ **
   - å¯¹è¯è·¯ç”±ï¼šä¼ é€’ `req.user.username` åˆ° ProcessManager
   - æ–‡ä»¶ç³»ç»Ÿè·¯ç”±ï¼šé™åˆ¶è®¿é—®èŒƒå›´åˆ° `userContext.workspaceDir`
   - æµå¼è·¯ç”±ï¼šSSE è¿æ¥éªŒè¯ Token + Cookie

4. **SSE è®¤è¯å¤„ç†**
   - æµè§ˆå™¨ EventSource è‡ªåŠ¨æºå¸¦ Cookie
   - ä¼ä¸šç½‘å…³è‡ªåŠ¨æ³¨å…¥ Header
   - åç«¯ `gatewayAuthMiddleware` éªŒè¯

**éªŒæ”¶æ ‡å‡†**ï¼š
- æ‰€æœ‰ API éœ€è¦è®¤è¯æ‰èƒ½è®¿é—®
- æœªè®¤è¯è¯·æ±‚è¿”å› 401
- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„èµ„æº
- SSE è¿æ¥æ­£ç¡®è®¤è¯

**é£é™©ç­‰çº§**ï¼šä½

---

### é˜¶æ®µ4ï¼šå®‰å…¨åŠ å›ºä¸èµ„æºç®¡ç†ï¼ˆ2-3å‘¨ï¼‰ã€P1ã€‘

**ç›®æ ‡**ï¼šæå‡ç³»ç»Ÿå®‰å…¨æ€§ä¸ç¨³å®šæ€§

**æ ¸å¿ƒæ”¹é€ **ï¼š

1. **è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼ˆæ–°å¢ `ProcessLifecycleManager`ï¼‰
   - **ç©ºé—²è¶…æ—¶å›æ”¶**ï¼ˆIdle GCï¼‰ï¼š
     - ç»´æŠ¤æ¯ä¸ªä¼šè¯çš„ `lastActivityTime`
     - å®šæ—¶æ‰«æï¼ˆæ¯åˆ†é’Ÿï¼‰ï¼Œè¶…è¿‡ 10 åˆ†é’Ÿæ— äº¤äº’ â†’ kill è¿›ç¨‹
   - **è¿æ¥æ–­å¼€è”åŠ¨**ï¼š
     - ç›‘å¬ SSE è¿æ¥ `close` äº‹ä»¶
     - å¯åŠ¨å€’è®¡æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰ï¼Œæœªé‡è¿åˆ™å›æ”¶
   - **LRU è¿›ç¨‹æ·˜æ±°**ï¼š
     - è®¾ç½®æœ€å¤§å¹¶å‘æ•°ï¼ˆå¦‚ 100 ä¸ªï¼‰
     - è¾¾åˆ°ä¸Šé™æ—¶ï¼Œå¼ºåˆ¶å›æ”¶"æœ€ä¹…æœªæ´»åŠ¨"çš„è¿›ç¨‹
   - **å‰ç«¯å¿ƒè·³æœºåˆ¶**ï¼š
     - å‰ç«¯æ¯åˆ†é’Ÿå‘é€ `POST /api/heartbeat`
     - é˜²æ­¢æ­£åœ¨ä½¿ç”¨çš„è¿›ç¨‹è¢«è¯¯å›æ”¶

2. **ç”¨æˆ·çº§æ—¥å¿—åˆ†æµ**
   - Claude CLI çš„ stdout/stderr é‡å®šå‘åˆ°ç”¨æˆ·ç›®å½•
   - è·¯å¾„ï¼š`/mnt/bdap/<username>/.cui/logs/claude-cli-<date>.log`

3. **å®¡è®¡æ—¥å¿—**ï¼ˆæ–°å¢ `AuditLogger`ï¼‰
   - è®°å½•ï¼šå¯åŠ¨å¯¹è¯ã€æ‰§è¡ŒBashã€æ–‡ä»¶æ“ä½œ
   - å­˜å‚¨åˆ° `audit_logs` è¡¨
   - åŒ…å«ï¼šç”¨æˆ·ã€æ“ä½œã€èµ„æºã€æ—¶é—´ã€IPã€ç»“æœ

4. **é€Ÿç‡é™åˆ¶**ï¼ˆæ–°å¢ä¸­é—´ä»¶ï¼‰
   - é™åˆ¶å•ç”¨æˆ· API è¯·æ±‚é¢‘ç‡ï¼ˆå¦‚ 100 req/minï¼‰
   - åŸºäº userId é™æµï¼Œé˜²æ­¢æ¶æ„æ”»å‡»

5. **æ–‡ä»¶ç³»ç»Ÿæƒé™éªŒè¯**
   - ç”¨æˆ·ç›®å½•æƒé™ï¼š`700 (drwx------)`
   - ç›®å½•æ‰€æœ‰è€…ï¼šçœŸå®ç”¨æˆ·
   - é…ç½®æ–‡ä»¶æƒé™ï¼š`600 (-rw-------)`
   - ç¼–å†™éªŒè¯è„šæœ¬ï¼š`scripts/verify-permissions.sh`

**éªŒæ”¶æ ‡å‡†**ï¼š
- ç©ºé—²è¿›ç¨‹åœ¨ 10 åˆ†é’Ÿåè‡ªåŠ¨å›æ”¶
- è¾¾åˆ°æœ€å¤§å¹¶å‘æ•°æ—¶ï¼Œæ—§è¿›ç¨‹è¢«æ­£ç¡®æ·˜æ±°
- è¿æ¥æ–­å¼€åï¼Œèµ„æºåŠæ—¶é‡Šæ”¾
- æ¯ä¸ªç”¨æˆ·æ—¥å¿—å†™å…¥å„è‡ªç›®å½•
- å…³é”®æ“ä½œæœ‰å®¡è®¡è®°å½•
- API æœ‰é€Ÿç‡é™åˆ¶
- æ–‡ä»¶æƒé™æ£€éªŒé€šè¿‡

**é£é™©ç­‰çº§**ï¼šä¸­

---

### é˜¶æ®µ5ï¼šå‰ç«¯æ”¹é€ å’Œæµ‹è¯•ï¼ˆ1-2å‘¨ï¼‰ã€P1ã€‘

**ç›®æ ‡**ï¼šå‰ç«¯é€‚é…å¤šç”¨æˆ·ä½“éªŒï¼Œå®Œå–„æµ‹è¯•

**æ ¸å¿ƒæ”¹é€ **ï¼š

1. **å‰ç«¯é€‚é…**ï¼ˆç®€åŒ–ï¼Œæ— éœ€ç™»å½•é¡µé¢ï¼‰
   - ç”¨æˆ·ä¿¡æ¯å±•ç¤ºï¼ˆå½“å‰ç”¨æˆ·åã€é…é¢ï¼‰
   - é…é¢ä½¿ç”¨æç¤ºï¼ˆæ¥è¿‘ä¸Šé™æ—¶è­¦å‘Šï¼‰
   - ä¼šè¯åˆ—è¡¨éš”ç¦»æç¤º

2. **æµ‹è¯•**
   - **å•å…ƒæµ‹è¯•**ï¼š
     - `gatewayAuthMiddleware` Token/Cookie éªŒè¯
     - `UserMappingService` ç”¨æˆ·ç›®å½•è¯»å–
     - `ConfigService` å¤šç”¨æˆ·é…ç½®åŠ è½½
   - **é›†æˆæµ‹è¯•**ï¼š
     - ç”¨æˆ·éš”ç¦»éªŒè¯ï¼ˆç”¨æˆ·Aæ— æ³•è®¿é—®ç”¨æˆ·Bèµ„æºï¼‰
     - è¿›ç¨‹éš”ç¦»éªŒè¯ï¼ˆè¿›ç¨‹euidä¸ºçœŸå®ç”¨æˆ·ï¼‰
     - ä¼šè¯éš”ç¦»éªŒè¯ï¼ˆä¼šè¯æŒ‰user_idè¿‡æ»¤ï¼‰
   - **å‹åŠ›æµ‹è¯•**ï¼š
     - 200 å¹¶å‘ç”¨æˆ·ç™»å½•
     - 500 å¹¶å‘å¯¹è¯
   - **å®‰å…¨æµ‹è¯•**ï¼š
     - è·¯å¾„æ³¨å…¥æ”»å‡»ï¼ˆ`../../../etc/passwd`ï¼‰
     - æƒé™è¶Šæƒï¼ˆè·¨ç”¨æˆ·è®¿é—®ï¼‰

3. **æ–‡æ¡£**
   - ç”¨æˆ·æ‰‹å†Œï¼šå¦‚ä½•é€šè¿‡ç½‘å…³è®¿é—®
   - ç®¡ç†å‘˜æ‰‹å†Œï¼šç½‘å…³é…ç½®ã€ç”¨æˆ·ç›®å½•åˆå§‹åŒ–ã€ç›‘æ§æŒ‡å—
   - APIæ–‡æ¡£ï¼šè®¤è¯æ–¹å¼è¯´æ˜
   - æ•…éšœæ’æŸ¥æŒ‡å—

**éªŒæ”¶æ ‡å‡†**ï¼š
- ç”¨æˆ·é€šè¿‡ç½‘å…³è®¿é—®ç³»ç»Ÿ
- æµ‹è¯•è¦†ç›–ç‡ > 80%
- æ–‡æ¡£å®Œå–„
- æ‰€æœ‰å®‰å…¨æµ‹è¯•é€šè¿‡

**é£é™©ç­‰çº§**ï¼šä½

---

### é˜¶æ®µ6ï¼šéƒ¨ç½²å’Œä¸Šçº¿ï¼ˆ1å‘¨ï¼‰ã€P0ã€‘

**ç›®æ ‡**ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¹¶éªŒè¯

**æ ¸å¿ƒä»»åŠ¡**ï¼š
1. æœåŠ¡å™¨é…ç½®ï¼ˆ16-32æ ¸ã€128GB RAMã€500GB SSDï¼‰
2. MySQL æ•°æ®åº“éƒ¨ç½²ä¸åˆå§‹åŒ–
3. ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ`GATEWAY_TOKEN`ã€æ•°æ®åº“è¿æ¥ï¼‰
4. Systemd æœåŠ¡é…ç½®ï¼ˆä»¥ `hadoop` ç”¨æˆ·è¿è¡Œï¼‰
5. Nginx åå‘ä»£ç†ï¼ˆHTTPSã€SSEæ”¯æŒï¼‰
6. ç›‘æ§å‘Šè­¦é…ç½®
7. æ€§èƒ½åŸºå‡†æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**ï¼š
- ç³»ç»Ÿåœ¨ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œ
- ç›‘æ§å’Œå‘Šè­¦æ­£å¸¸
- æ€§èƒ½æ»¡è¶³è¦æ±‚ï¼ˆ200-500å¹¶å‘ï¼‰

**é£é™©ç­‰çº§**ï¼šä¸­

---

## 1.3 æ ¸å¿ƒæµç¨‹è®¾è®¡

### 1.3.1 ç”¨æˆ·ç™»å½•ä¸è¯·æ±‚å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant Browser as æµè§ˆå™¨
    participant Gateway as ä¼ä¸šç½‘å…³
    participant Server as CUI Server
    participant Middleware as è®¤è¯ä¸­é—´ä»¶
    participant UserService as UserService
    participant DB as MySQL

    Browser->>Gateway: 1. è®¿é—® CUIï¼ˆæºå¸¦èº«ä»½ï¼‰
    Gateway->>Gateway: 2. SSOç™»å½•éªŒè¯
    Gateway->>Browser: 3. è¿”å› Token + Cookie<br>Set-Cookie: dss_user_name=zhangsan<br>Header: X-Gateway-Token

    Browser->>Server: 4. GET /api/users/me<br>Cookie: dss_user_name=zhangsan<br>Header: X-Gateway-Token

    Server->>Middleware: 5. è®¤è¯ä¸­é—´ä»¶å¤„ç†
    Middleware->>Middleware: 6. è§£æ Header Token
    Middleware->>Middleware: 7. è¯»å– Cookie ç”¨æˆ·å
    Middleware->>Middleware: 8. éªŒè¯ç”¨æˆ·åæ ¼å¼<br>é˜² ../../../etc/passwd

    Middleware->>UserService: 9. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯<br>getUserByUsername(zhangsan)
    UserService->>DB: 10. SELECT * FROM users<br>WHERE username = 'zhangsan'
    DB-->>UserService: 11. è¿”å›ç”¨æˆ·ä¿¡æ¯

    UserService->>UserService: 12. éªŒè¯ç”¨æˆ·ç›®å½•å­˜åœ¨<br>/mnt/bdap/zhangsan/

    UserService-->>Middleware: 13. è¿”å›ç”¨æˆ·å¯¹è±¡

    Middleware-->>Server: 14. æ³¨å…¥ req.user

    alt è®¤è¯æˆåŠŸ
        Server-->>Browser: 15a. 200 OK { user info }
    else è®¤è¯å¤±è´¥
        Server-->>Browser: 15b. 401 Unauthorized
    end
```

#### å…³é”®èŠ‚ç‚¹è¯´æ˜

| èŠ‚ç‚¹ | å¤„ç†é€»è¾‘ | è¾“å…¥/è¾“å‡º | å¼‚å¸¸å¤„ç† |
|-----|---------|----------|---------|
| 4. è¯·æ±‚ | æµè§ˆå™¨æºå¸¦ Token å’Œ Cookie å‘é€è¯·æ±‚ | **è¾“å…¥**: Headerã€Cookie<br>**è¾“å‡º**: HTTPè¯·æ±‚ | æ— Token/Cookieè¿”å›401 |
| 6-8. è®¤è¯éªŒè¯ | è§£æå’ŒéªŒè¯ Tokenã€Cookieã€ç”¨æˆ·åæ ¼å¼ | **è¾“å…¥**: Tokenã€Cookie<br>**è¾“å‡º**: åˆæ³•ç”¨æˆ·åæˆ–é”™è¯¯ | æ ¼å¼é”™è¯¯è¿”å›400 |
| 9-13. æŸ¥è¯¢ç”¨æˆ· | æŸ¥è¯¢æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯ï¼ŒéªŒè¯ç›®å½•å­˜åœ¨ | **è¾“å…¥**: ç”¨æˆ·å<br>**è¾“å‡º**: ç”¨æˆ·å¯¹è±¡æˆ–null | ç”¨æˆ·ä¸å­˜åœ¨è¿”å›401 |
| 14. æ³¨å…¥ä¸Šä¸‹æ–‡ | å°†ç”¨æˆ·ä¿¡æ¯æ³¨å…¥åˆ° req.userï¼Œåç»­è·¯ç”±å¯ç”¨ | **è¾“å…¥**: ç”¨æˆ·å¯¹è±¡<br>**è¾“å‡º**: req.user | æ³¨å…¥å¤±è´¥è¿”å›500 |

#### æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

| éš¾ç‚¹ | é—®é¢˜æè¿° | è§£å†³æ–¹æ¡ˆ | å†³ç­–ç†ç”± |
|-----|---------|---------|---------|
| TokenéªŒè¯å¯é æ€§ | ç½‘å…³Tokenæ ¼å¼æœªæ˜ç¡®ï¼Œå¯èƒ½å˜æ›´ | ä¸ç½‘å…³å›¢é˜Ÿç¡®è®¤Tokenæ ¼å¼å’ŒéªŒè¯æ–¹å¼ï¼Œç¼–å†™å•å…ƒæµ‹è¯•è¦†ç›– | æ—©æœŸå¯¹æ¥å‡å°‘é›†æˆé£é™© |
| è·¯å¾„æ³¨å…¥é˜²æŠ¤ | ç”¨æˆ·åæ¥è‡ªCookieï¼Œå¯èƒ½è¢«ç¯¡æ”¹ä¸º `../` ç­‰ | ç™½åå•éªŒè¯ï¼šç”¨æˆ·åä»…å…è®¸å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼Œé•¿åº¦1-32 | é˜²æ­¢ç›®å½•éå†æ”»å‡» |
| ç›®å½•å­˜åœ¨éªŒè¯ | éœ€è¦é«˜æ•ˆéªŒè¯å¤§é‡ç”¨æˆ·ç›®å½•å­˜åœ¨ | ç¼“å­˜å·²éªŒè¯ç”¨æˆ·ï¼Œå®šæœŸåˆ·æ–°ï¼›ä½¿ç”¨ stat è€Œé ls | é¿å…é¢‘ç¹æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨ |
| å¹¶å‘è®¤è¯ | é«˜å¹¶å‘è¯·æ±‚å¯èƒ½å¯¼è‡´è®¤è¯ç“¶é¢ˆ | ä½¿ç”¨ Redis ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼›è®¾ç½®ç¼“å­˜TTL 5åˆ†é’Ÿ | æƒè¡¡ä¸€è‡´æ€§å’Œæ€§èƒ½ |

#### è¾¹ç•Œä¸çº¦æŸè¯´æ˜

- **å‰ç½®æ¡ä»¶**ï¼šç½‘å…³å·²å®ŒæˆSSOç™»å½•ï¼Œæµè§ˆå™¨æœ‰æœ‰æ•ˆToken + Cookie
- **åç½®ä¿è¯**ï¼šè®¤è¯é€šè¿‡åï¼Œreq.user æ³¨å…¥ç”¨æˆ·å®Œæ•´ä¿¡æ¯ï¼Œåç»­è·¯ç”±å¯ä¿¡ä»»
- **å¹¶å‘çº¦æŸ**ï¼šæ”¯æŒå¹¶å‘ï¼Œæ— çŠ¶æ€è®¾è®¡ï¼Œæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹éªŒè¯
- **æ€§èƒ½çº¦æŸ**ï¼šè®¤è¯ P99 < 50msï¼ˆå«æ•°æ®åº“æŸ¥è¯¢ï¼‰
- **å¹‚ç­‰æ€§**ï¼šè®¤è¯æµç¨‹å¹‚ç­‰ï¼Œé‡å¤è¯·æ±‚è¿”å›ç›¸åŒç»“æœ

---

### 1.3.2 ç”¨æˆ·å¯åŠ¨å¯¹è¯æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å‰ç«¯
    participant API as å¯¹è¯API
    participant ConfigService as ConfigService
    participant ProcessMgr as ProcessManager
    participant Linux as æ“ä½œç³»ç»Ÿ
    participant ClaudeCLI as Claude CLI

    Client->>API: 1. POST /api/conversations<br>req.user.username = "zhangsan"

    API->>ConfigService: 2. loadUserConfig(zhangsan)
    ConfigService->>ConfigService: 3. è¯»å–ç”¨æˆ·é…ç½®<br>/mnt/bdap/zhangsan/.cui/config.json
    ConfigService-->>API: 4. è¿”å› CUIConfig

    API->>ProcessMgr: 5. startConversation(config + userContext)

    ProcessMgr->>ProcessMgr: 6. æ„å»ºå¯åŠ¨å‘½ä»¤

    ProcessMgr->>Linux: 7. spawn('sudo', [<br>'-u', 'zhangsan',<br>'-i', '--', 'claude', ...args<br>])

    alt sudo éªŒè¯ & æƒé™æ£€æŸ¥
        Linux->>Linux: 8a. éªŒè¯ hadoop ç”¨æˆ·æœ‰ NOPASSWD æƒé™
        Linux->>Linux: 9a. ä»¥ zhangsan èº«ä»½å¯åŠ¨å­è¿›ç¨‹
        Linux-->>ProcessMgr: 10a. è¿›ç¨‹ID = 12345
    else æƒé™ä¸è¶³
        Linux-->>ProcessMgr: 10b. é”™è¯¯ï¼šPermission denied
    end

    ProcessMgr->>ProcessMgr: 11. è®°å½•è¿›ç¨‹æ˜ å°„<br>{ pid: 12345, euid: zhangsan,<br>  username: zhangsan,<br>  lastActivityTime: now }<br>

    ProcessMgr->>ClaudeCLI: 12. Claude CLI å¯åŠ¨<br>ç¯å¢ƒå˜é‡ï¼š<br>HOME=/mnt/bdap/zhangsan<br>CLAUDE_API_KEY=...<br>å·¥ä½œç›®å½•ï¼š/mnt/bdap/zhangsan/workspace

    ProcessMgr-->>API: 13. è¿”å› conversationId
    API-->>Client: 14. è¿”å› { conversationId, status: 'started' }
```

#### å…³é”®èŠ‚ç‚¹è¯´æ˜

| èŠ‚ç‚¹ | å¤„ç†é€»è¾‘ | è¾“å…¥/è¾“å‡º | å¼‚å¸¸å¤„ç† |
|-----|---------|----------|---------|
| 2-4. é…ç½®åŠ è½½ | ä»ç”¨æˆ·ç›®å½•è¯»å–é…ç½®æ–‡ä»¶ï¼Œç¼“å­˜ | **è¾“å…¥**: username<br>**è¾“å‡º**: CUIConfig å¯¹è±¡ | æ–‡ä»¶ä¸å­˜åœ¨â†’ä½¿ç”¨é»˜è®¤é…ç½® |
| 6-10. è¿›ç¨‹å¯åŠ¨ | ä½¿ç”¨ sudo -u åˆ‡æ¢ç”¨æˆ·ï¼Œå¯åŠ¨Claude CLI | **è¾“å…¥**: ç”¨æˆ·åã€å¯åŠ¨å‚æ•°<br>**è¾“å‡º**: è¿›ç¨‹ID (PID) | sudoå¤±è´¥â†’è¿”å›é”™è¯¯æç¤º |
| 11. è¿›ç¨‹è¿½è¸ª | ç»´æŠ¤è¿›ç¨‹æ˜ å°„è¡¨ï¼Œè®°å½• euidã€æ´»åŠ¨æ—¶é—´ | **è¾“å…¥**: PIDã€ç”¨æˆ·å<br>**è¾“å‡º**: å†…å­˜æ˜ å°„è¡¨æ›´æ–° | æ˜ å°„é‡å¤â†’è¦†ç›–æ—§è®°å½• |
| 12-14. è¿”å›ç»“æœ | è¿”å›å¯¹è¯IDä¾›å‰ç«¯ SSE è¿æ¥ | **è¾“å…¥**: æ— <br>**è¾“å‡º**: conversationId | æ— å¼‚å¸¸æƒ…å†µ |

#### æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

| éš¾ç‚¹ | é—®é¢˜æè¿° | è§£å†³æ–¹æ¡ˆ | å†³ç­–ç†ç”± |
|-----|---------|---------|---------|
| Sudoæƒé™é…ç½® | sudo éœ€è¦ NOPASSWD æƒé™ï¼Œå¦åˆ™éœ€è¦å¯†ç è¾“å…¥ | ç¼–å†™éƒ¨ç½²è„šæœ¬é…ç½® sudoers æ–‡ä»¶ï¼›è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬ | å‡å°‘è¿ç»´é”™è¯¯ |
| ç¯å¢ƒå˜é‡ç»§æ‰¿ | Claude CLI éœ€è¦ç»§æ‰¿ç”¨æˆ·çš„ç¯å¢ƒå˜é‡ | ä½¿ç”¨ `sudo -i` åŠ è½½ç”¨æˆ·å®Œæ•´ç™»å½•ç¯å¢ƒ | ç¡®ä¿HOMEã€PATHç­‰æ­£ç¡® |
| è¿›ç¨‹åƒµå°¸é—®é¢˜ | å­è¿›ç¨‹é€€å‡ºåå¯èƒ½å˜æˆåƒµå°¸è¿›ç¨‹ | çˆ¶è¿›ç¨‹ç›‘å¬ SIGCHLDï¼ŒåŠæ—¶ waitpid() | é˜²æ­¢è¿›ç¨‹è¡¨æ±¡æŸ“ |
| å¤§é‡å¹¶å‘å¯åŠ¨ | çŸ­æ—¶é—´å†…å¯åŠ¨å¤§é‡è¿›ç¨‹å¯èƒ½è¶…è¿‡ç³»ç»Ÿé™åˆ¶ | è®¾ç½® ulimitã€ä½¿ç”¨è¿›ç¨‹æ± ç®¡ç† | ä¿è¯ç³»ç»Ÿç¨³å®šæ€§ |

#### è¾¹ç•Œä¸çº¦æŸè¯´æ˜

- **å‰ç½®æ¡ä»¶**ï¼šç”¨æˆ·å·²è®¤è¯ï¼Œç”¨æˆ·ç›®å½•å­˜åœ¨ä¸”æƒé™æ­£ç¡® (700)ï¼Œsudo é…ç½®å®Œæˆ
- **åç½®ä¿è¯**ï¼šClaude CLI è¿›ç¨‹ä»¥çœŸå®ç”¨æˆ·èº«ä»½è¿è¡Œï¼Œeuid = çœŸå®ç”¨æˆ·ID
- **å¹¶å‘çº¦æŸ**ï¼šæ”¯æŒé«˜å¹¶å‘å¯åŠ¨ï¼Œæ¯ä¸ªç”¨æˆ·æœ€å¤š100ä¸ªå¹¶å‘è¿›ç¨‹ï¼ˆLRUæ·˜æ±°ï¼‰
- **æ€§èƒ½çº¦æŸ**ï¼šå¯åŠ¨å»¶è¿Ÿ P99 < 2sï¼ˆå«æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼‰
- **å¹‚ç­‰æ€§**ï¼šéå¹‚ç­‰ï¼Œé‡å¤è¯·æ±‚äº§ç”Ÿæ–°è¿›ç¨‹

---

## 1.4 è¿›ç¨‹éš”ç¦»å®ç°

### æƒé™éš”ç¦»æ¨¡å‹

```
CUI Server (hadoop:hadoop)
  â””â”€ euid=0 (root equivalent)
      â”‚
      â””â”€â”€ Clone (sudo verification)
           â”‚
           â””â”€ Setuid to zhangsan (çœŸå®ç”¨æˆ·)
                â”‚
                â””â”€ Claude CLI è¿›ç¨‹
                     euid = 1001 (zhangsan)
                     uid = 1001 (zhangsan)
                     gid = 1001 (zhangsan)

                     å¯è®¿é—®çš„èµ„æºï¼š
                     - /mnt/bdap/zhangsan/         (700)
                     - /home/zhangsan/             (700)
                     - /var/tmp/                   (RWX)

                     æ— æ³•è®¿é—®ï¼š
                     - /mnt/bdap/lisi/             (700, å¦ä¸€ç”¨æˆ·)
                     - /root/                      (700)
                     - /etc/shadow                 (ä»…rootå¯è¯»)
```

### éªŒè¯è¿›ç¨‹éš”ç¦»

```bash
# æ–¹æ¡ˆ1ï¼šps æ£€æŸ¥ euid
$ ps -eo pid,euid,cmd | grep claude

# è¾“å‡ºç¤ºä¾‹ï¼š
#  1234  1001 claude code ...  ï¼ˆzhangsanå¯åŠ¨ï¼‰
#  1235  1002 claude code ...  ï¼ˆlisiå¯åŠ¨ï¼‰
#  1236     0 /bin/bash        ï¼ˆhadoopå¯åŠ¨çš„ç®¡ç†è¿›ç¨‹ï¼‰

# æ–¹æ¡ˆ2ï¼šls æ£€æŸ¥æ–‡ä»¶æƒé™
$ ls -ld /mnt/bdap/zhangsan /mnt/bdap/lisi
drwx------ 5 zhangsan zhangsan   /mnt/bdap/zhangsan
drwx------ 5 lisi     lisi       /mnt/bdap/lisi

# æ–¹æ¡ˆ3ï¼šå°è¯•è·¨ç”¨æˆ·è®¿é—®ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
$ sudo -u zhangsan cat /mnt/bdap/lisi/.cui/config.json
# è¾“å‡ºï¼šcat: /mnt/bdap/lisi/.cui/config.json: Permission denied âœ…
```

---

## 1.5 å…³é”®æ¥å£å®šä¹‰

### 1.5.1 è®¤è¯ä¸­é—´ä»¶æ¥å£

```typescript
/**
 * ç½‘å…³è®¤è¯ä¸­é—´ä»¶
 *
 * æ ¸å¿ƒèŒè´£ï¼š
 * 1. éªŒè¯ X-Gateway-Token Header
 * 2. è¯»å– dss_user_name Cookie
 * 3. éªŒè¯ç”¨æˆ·åæ ¼å¼å’Œç›®å½•å­˜åœ¨
 * 4. æ³¨å…¥ req.user ä¸Šä¸‹æ–‡
 */
interface GatewayAuthMiddleware {
  /**
   * ä¸­é—´ä»¶å¤„ç†å‡½æ•°
   *
   * æ ¸å¿ƒé€»è¾‘ï¼š
   * 1. è§£æ request ä¸­çš„ Token å’Œ Cookie
   * 2. è°ƒç”¨ UserMappingService éªŒè¯ç”¨æˆ·ä¿¡æ¯
   * 3. æ³¨å…¥ req.user = { username, homeDir, ... }
   * 4. è°ƒç”¨ next() ç»§ç»­å¤„ç†
   *
   * @param req Express Request
   * @param res Express Response
   * @param next ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
   * @throws æ— è®¤è¯ä¿¡æ¯ â†’ è¿”å› 401
   * @throws ç”¨æˆ·ä¸å­˜åœ¨ â†’ è¿”å› 401
   * @throws æ ¼å¼éæ³• â†’ è¿”å› 400
   */
  (req: Request, res: Response, next: NextFunction): void;
}

interface UserContext {
  username: string;        // ç”¨æˆ·åï¼šzhangsan
  homeDir: string;         // /mnt/bdap/zhangsan
  workspaceDir: string;    // /mnt/bdap/zhangsan/workspace
  claudeDir: string;       // /mnt/bdap/zhangsan/.claude
  cuiDir: string;          // /mnt/bdap/zhangsan/.cui
}
```

### 1.5.2 ConfigService æ¥å£

```typescript
/**
 * å¤šç”¨æˆ·é…ç½®æœåŠ¡
 *
 * æ ¸å¿ƒèŒè´£ï¼š
 * 1. æŒ‰ç”¨æˆ·åŠ è½½ .cui/config.json
 * 2. ç¼“å­˜ç”¨æˆ·é…ç½®ï¼Œé¿å…é¢‘ç¹æ–‡ä»¶IO
 * 3. æ”¯æŒé…ç½®çƒ­æ›´æ–°
 */
interface ConfigService {
  /**
   * åŠ è½½ç”¨æˆ·é…ç½®
   *
   * @param username ç”¨æˆ·å
   * @param userCuiDir ç”¨æˆ· .cui ç›®å½•è·¯å¾„
   * @return ç”¨æˆ·é…ç½®å¯¹è±¡ï¼Œè‹¥ä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤é…ç½®
   */
  loadUserConfig(username: string, userCuiDir: string): Promise<CUIConfig>;

  /**
   * è·å–ç¼“å­˜çš„é…ç½®ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
   */
  getCachedConfig(username: string): CUIConfig | null;

  /**
   * æ¸…é™¤ç”¨æˆ·é…ç½®ç¼“å­˜
   */
  clearUserCache(username: string): void;
}
```

### 1.5.3 ClaudeProcessManager æ¥å£

```typescript
/**
 * å¤šç”¨æˆ·è¿›ç¨‹ç®¡ç†å™¨
 *
 * æ ¸å¿ƒèŒè´£ï¼š
 * 1. ä»¥ sudo -u <user> å¯åŠ¨ Claude CLI è¿›ç¨‹
 * 2. ç»´æŠ¤è¿›ç¨‹ä¸ç”¨æˆ·çš„æ˜ å°„å…³ç³»
 * 3. æ”¯æŒè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»ºã€ç»ˆæ­¢ã€å›æ”¶ï¼‰
 */
interface ClaudeProcessManager {
  /**
   * å¯åŠ¨ç”¨æˆ·å¯¹è¯
   *
   * @param config å¯¹è¯é…ç½®
   * @param userContext ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¿…é¡»åŒ…å« usernameï¼‰
   * @return conversationId å’Œè¿›ç¨‹ä¿¡æ¯
   *
   * æ ¸å¿ƒé€»è¾‘ï¼š
   * 1. ä½¿ç”¨ ConfigService åŠ è½½ç”¨æˆ·é…ç½®
   * 2. æ„å»º spawn å‘½ä»¤ï¼šsudo -u <username> -i -- claude ...
   * 3. æ‰§è¡Œè¿›ç¨‹ï¼Œè·å– PID
   * 4. è®°å½•è¿›ç¨‹æ˜ å°„ï¼š{ pid, euid, username, lastActivityTime }
   * 5. è¿”å› conversationId
   */
  startConversation(
    config: MultiUserConversationConfig,
    userContext: UserContext
  ): Promise<{ conversationId: string; processInfo: ProcessInfo }>;

  /**
   * è·å–ç”¨æˆ·çš„æ‰€æœ‰è¿›ç¨‹
   *
   * @param username ç”¨æˆ·å
   * @return è¯¥ç”¨æˆ·å¯åŠ¨çš„æ‰€æœ‰è¿›ç¨‹åˆ—è¡¨
   */
  getProcessesByUser(username: string): ProcessInfo[];

  /**
   * æ›´æ–°è¿›ç¨‹æ´»åŠ¨æ—¶é—´ï¼ˆå¿ƒè·³ï¼‰
   */
  updateProcessActivity(pid: number): void;

  /**
   * ç»ˆæ­¢è¿›ç¨‹
   */
  terminateProcess(pid: number): Promise<void>;
}
```

---

## 1.6 è®¾è®¡å†³ç­–è®°å½• (ADR)

### ADR-001: ä½¿ç”¨ sudo -u åˆ‡æ¢ç”¨æˆ·éš”ç¦»è¿›ç¨‹

**çŠ¶æ€**ï¼šå·²é‡‡çº³

**èƒŒæ™¯**ï¼šéœ€è¦åœ¨ Linux ç³»ç»Ÿä¸Šå®ç°è¿›ç¨‹çº§åˆ«çš„ç”¨æˆ·éš”ç¦»ï¼Œç¡®ä¿ä¸€ä¸ªç”¨æˆ·çš„è¿›ç¨‹æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·çš„æ–‡ä»¶ã€‚

**å†³ç­–**ï¼šé‡‡ç”¨ `sudo -u <username> -i -- claude ...` åˆ‡æ¢åˆ°çœŸå®ç”¨æˆ·èº«ä»½å¯åŠ¨ Claude CLI è¿›ç¨‹ã€‚

**é€‰é¡¹å¯¹æ¯”**ï¼š

| é€‰é¡¹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|---------|
| **sudo -u åˆ‡æ¢ç”¨æˆ·**ï¼ˆé‡‡çº³ï¼‰ | åˆ©ç”¨æˆç†Ÿçš„Linuxæƒé™æ¨¡å‹ï¼Œéš”ç¦»å½»åº•å¯é ï¼Œè¿ç»´æ ‡å‡†åšæ³• | éœ€è¦ NOPASSWD sudo é…ç½® | ä¼ä¸šLinuxç¯å¢ƒ |
| Docker å®¹å™¨éš”ç¦» | éš”ç¦»æ›´å½»åº•ï¼ŒåŒ…æ‹¬ç½‘ç»œå‘½åç©ºé—´ | å¼€é”€å¤§ï¼Œæ€§èƒ½æŸè€—ï¼Œéœ€è¦å®¹å™¨ç¼–æ’ | å¾®æœåŠ¡æ¶æ„ |
| chroot/chown ä¿®æ”¹æ‰€æœ‰æƒ | é¿å… sudoï¼Œç®€åŒ–æƒé™é…ç½® | æ–‡ä»¶æ‰€æœ‰æƒä¸ç¬¦åˆè¿ç»´è§„èŒƒï¼Œéš¾ä»¥ç®¡ç† | æ—  |

**ç»“è®º**ï¼š
Linux æƒé™æ¨¡å‹ç»è¿‡æ•°åå¹´éªŒè¯ï¼Œ`sudo` æ˜¯æ ‡å‡†æ–¹æ¡ˆã€‚ä¸å…¶ä»–å¤æ‚æ–¹æ¡ˆç›¸æ¯”ï¼Œ`sudo -u` è¶³å¤Ÿå¯é ä¸”æ˜“äºè¿ç»´ã€‚

**å½±å“**ï¼š
- éƒ¨ç½²æ—¶éœ€è¦é…ç½® sudoersï¼š`hadoop ALL=(ALL) NOPASSWD: /usr/bin/claude`
- éœ€è¦ç¼–å†™éªŒè¯è„šæœ¬ç¡®ä¿é…ç½®æ­£ç¡®
- è¿›ç¨‹éš”ç¦»ç”±Linuxå†…æ ¸ä¿è¯ï¼Œå®‰å…¨å¯é 

---

### ADR-002: MySQL æ›¿ä»£ SQLite

**çŠ¶æ€**ï¼šå·²é‡‡çº³

**èƒŒæ™¯**ï¼šå•ç”¨æˆ·æ¶æ„ä¸‹ SQLite è¶³å¤Ÿï¼Œä½†å¤šç”¨æˆ·å¹¶å‘å†™å…¥ä¼šå¯¼è‡´æ•°æ®åº“é”ç«äº‰ã€‚

**å†³ç­–**ï¼šè¿ç§»åˆ° MySQL 8.0+ï¼Œä½¿ç”¨ `user_id` éš”ç¦»æ•°æ®ã€‚

**é€‰é¡¹å¯¹æ¯”**ï¼š

| é€‰é¡¹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|---------|
| **MySQL 8.0**ï¼ˆé‡‡çº³ï¼‰ | æˆç†Ÿã€ä¼ä¸šæ ‡å‡†ã€å¹¶å‘æ€§èƒ½å¥½ã€ç”Ÿæ€å®Œå–„ | éœ€è¦ç‹¬ç«‹éƒ¨ç½²ã€ç»´æŠ¤æˆæœ¬ç¨é«˜ | ä¼ä¸šçº§åº”ç”¨ |
| PostgreSQL 15 | åŠŸèƒ½å¼ºå¤§ã€JSONæ”¯æŒã€JSONBæ€§èƒ½ä¼˜ç§€ | å­¦ä¹ æˆæœ¬ã€ç¤¾åŒºç›¸å¯¹å° | æ•°æ®åˆ†æåœºæ™¯ |
| SQLite WALæ¨¡å¼ | æ— éœ€è¿ç§»ï¼Œç®€å•å¿«é€Ÿ | å•æœºç“¶é¢ˆæ˜æ˜¾ï¼Œè¿œä¸å¦‚MySQL | å•æœºå°è§„æ¨¡åœºæ™¯ |

**ç»“è®º**ï¼š
MySQL æ˜¯ä¼ä¸šæ ‡å‡†é€‰æ‹©ï¼Œå›¢é˜Ÿé€šå¸¸æœ‰ MySQL éƒ¨ç½²è¿ç»´ç»éªŒï¼Œé™ä½å­¦ä¹ æˆæœ¬ã€‚

**å½±å“**ï¼š
- æ‰€æœ‰æŸ¥è¯¢å¿…é¡»æ·»åŠ  `WHERE user_id = ?` è¿‡æ»¤
- éœ€è¦ `user_id` ç´¢å¼•ä¼˜åŒ–
- æ•°æ®åº“è¿æ¥æ± é…ç½®è°ƒä¼˜

---

### ADR-003: ç½‘å…³ç»Ÿä¸€è®¤è¯è€Œéè‡ªç ” JWT

**çŠ¶æ€**ï¼šå·²é‡‡çº³

**èƒŒæ™¯**ï¼šéœ€è¦è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œå¯ä»¥è‡ªç ” JWT è®¤è¯æˆ–æ¥å…¥ä¼ä¸šç½‘å…³ã€‚

**å†³ç­–**ï¼šæ¥å…¥ä¼ä¸šç½‘å…³çš„ Token + Cookie è®¤è¯ã€‚

**é€‰é¡¹å¯¹æ¯”**ï¼š

| é€‰é¡¹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|---------|
| **ç½‘å…³è®¤è¯**ï¼ˆé‡‡çº³ï¼‰ | é›†æˆç®€å•ã€å¤ç”¨ä¼ä¸šæŠ•èµ„ã€å·²æœ‰SSO | ä¾èµ–ç½‘å…³ç¨³å®šæ€§ã€è§„èŒƒå¯èƒ½å˜æ›´ | ä¼ä¸šå†…éƒ¨ç³»ç»Ÿ |
| è‡ªç ” JWT | ç‹¬ç«‹è‡ªä¸»ã€å®šåˆ¶åŒ– | å·¥ä½œé‡å¤§ã€éœ€è¦Tokenåˆ·æ–°ã€åŠ å¯†å¤æ‚ | ç‹¬ç«‹äº§å“ |
| LDAP ç›´è¿ | ä¸ä¼ä¸šADé›†æˆæ·± | é›†æˆå¤æ‚ã€æ€§èƒ½é£é™© | ä¼ä¸šå†…ç½‘ç¯å¢ƒ |

**ç»“è®º**ï¼š
ä¼ä¸šå·²æœ‰ç½‘å…³æŠ•èµ„å’Œæˆç†Ÿçš„SSOï¼Œåº”è¯¥å¤ç”¨è€Œéé‡å¤å»ºè®¾ã€‚

**å½±å“**ï¼š
- éœ€è¦ä¸ç½‘å…³å›¢é˜Ÿåå•† Token æ ¼å¼å’Œä¼ é€’æ–¹å¼
- Cookie åç§°å¯èƒ½ä¸ç½‘å…³åè®®å˜æ›´
- æœ¬åœ°è®¤è¯ä½œä¸ºé™çº§æ–¹æ¡ˆ

---

## 1.7 å…³é”®æŠ€æœ¯éš¾ç‚¹æ±‡æ€»

| éš¾ç‚¹ | é£é™© | ç¼“è§£æªæ–½ | ä¼˜å…ˆçº§ |
|-----|------|---------|-------|
| **Sudo æƒé™é…ç½®** | é«˜ | è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬ + é™çº§æ–¹æ¡ˆ | P0 |
| **ç½‘å…³é›†æˆæ—¶åº** | é«˜ | æå‰åå•† + æ¨¡æ‹Ÿç½‘å…³ç¯å¢ƒ + æœ¬åœ°é™çº§ | P0 |
| **ç”¨æˆ·ç›®å½•æƒé™** | é«˜ | æƒé™éªŒè¯è„šæœ¬ + è¿ç»´åŸ¹è®­ | P0 |
| **è¿›ç¨‹æ³„éœ²å¯¼è‡´èµ„æºè€—å°½** | ä¸­ | è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç† + ç›‘æ§å‘Šè­¦ | P1 |
| **æ•°æ®åº“è¿ç§»å¤±è´¥** | ä¸­ | è¿ç§»è„šæœ¬æµ‹è¯• + å›æ»šæ–¹æ¡ˆ | P1 |
| **å¿ƒè·³æœºåˆ¶è¯¯åˆ¤** | ä¸­ | å¿ƒè·³é—´éš”è°ƒä¼˜ + å®½æ¾çš„å›æ”¶é˜ˆå€¼ | P1 |
| **å›¢é˜Ÿæ¶æ„ä¸ç†Ÿæ‚‰** | ä¸­ | æŠ€æœ¯åˆ†äº« + æ–‡æ¡£æ³¨é‡Š + ä»£ç ç¤ºä¾‹ | P2 |

---

# Part 2: æ”¯æ’‘è®¾è®¡

> ğŸ“ **æœ¬å±‚ç›®æ ‡**ï¼šæ•°æ®æ¨¡å‹ã€APIè§„èŒƒã€é…ç½®ç­–ç•¥çš„ç»“æ„åŒ–æ‘˜è¦ã€‚
>
> **é¢„è®¡é˜…è¯»æ—¶é—´**ï¼š5-10åˆ†é’Ÿ

## 2.1 æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1.1 ç”¨æˆ·è¡¨ (users)

**è¡¨è¯´æ˜**ï¼šå­˜å‚¨ç³»ç»Ÿç”¨æˆ·åŸºæœ¬ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ | ç´¢å¼• |
|-------|------|------|------|------|
| id | BIGINT | ç”¨æˆ·ID | PK, AUTO_INCREMENT | PK |
| username | VARCHAR(32) | ç”¨æˆ·å | NOT NULL, UNIQUE | UNIQUE |
| home_dir | VARCHAR(256) | ç”¨æˆ·ä¸»ç›®å½• | NOT NULL | - |
| workspace_dir | VARCHAR(256) | å·¥ä½œç›®å½• | NOT NULL | - |
| is_active | BOOLEAN | æ˜¯å¦æ´»è·ƒ | NOT NULL, DEFAULT 1 | - |
| quota_per_month | INT | æœˆåº¦é…é¢ï¼ˆå¯¹è¯æ¬¡æ•°ï¼‰ | NOT NULL, DEFAULT 100 | - |
| quota_used | INT | æœ¬æœˆå·²ä½¿ç”¨ | NOT NULL, DEFAULT 0 | - |
| quota_reset_date | DATE | é…é¢é‡ç½®æ—¥æœŸ | NOT NULL | - |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | NOT NULL, DEFAULT NOW() | IDX |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ | NOT NULL, DEFAULT NOW() | - |

**ç´¢å¼•è®¾è®¡**ï¼š

| ç´¢å¼•å | ç±»å‹ | å­—æ®µ | ç”¨é€” |
|-------|------|------|------|
| PRIMARY | ä¸»é”® | id | ä¸»é”®æŸ¥è¯¢ |
| UNIQUE idx_username | å”¯ä¸€ç´¢å¼• | username | ç”¨æˆ·åæŸ¥è¯¢ã€é˜²é‡å¤ |
| idx_created_at | æ™®é€šç´¢å¼• | created_at | æ—¶é—´èŒƒå›´æŸ¥è¯¢ |

---

### 2.1.2 ä¼šè¯è¡¨ (sessions)

**è¡¨è¯´æ˜**ï¼šå­˜å‚¨ç”¨æˆ·å¯¹è¯ä¼šè¯ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ | ç´¢å¼• |
|-------|------|------|------|------|
| id | BIGINT | ä¼šè¯ID | PK, AUTO_INCREMENT | PK |
| user_id | BIGINT | ç”¨æˆ·ID | NOT NULL, FK | FK, IDX |
| conversation_id | VARCHAR(64) | å¯¹è¯ID | NOT NULL, UNIQUE | UNIQUE |
| process_id | INT | è¿›ç¨‹ID | NOT NULL | IDX |
| title | VARCHAR(256) | ä¼šè¯æ ‡é¢˜ | DEFAULT '' | - |
| status | ENUM('running', 'completed', 'error') | ä¼šè¯çŠ¶æ€ | NOT NULL | IDX |
| last_activity_time | DATETIME | æœ€åæ´»åŠ¨æ—¶é—´ | NOT NULL | IDX |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | NOT NULL, DEFAULT NOW() | - |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ | NOT NULL, DEFAULT NOW() | - |

**ç´¢å¼•è®¾è®¡**ï¼š

| ç´¢å¼•å | ç±»å‹ | å­—æ®µ | ç”¨é€” |
|-------|------|------|------|
| FK idx_user_id | å¤–é”®ç´¢å¼• | user_id | æŒ‰ç”¨æˆ·æŸ¥è¯¢ä¼šè¯ |
| UNIQUE idx_conversation_id | å”¯ä¸€ç´¢å¼• | conversation_id | ä¼šè¯å»é‡ |
| idx_status_user | å¤åˆç´¢å¼• | status, user_id | æŒ‰ç”¨æˆ·å’ŒçŠ¶æ€æŸ¥è¯¢ |
| idx_last_activity | æ™®é€šç´¢å¼• | last_activity_time | è¿›ç¨‹å›æ”¶æ‰«æ |

---

### 2.1.3 å®¡è®¡æ—¥å¿—è¡¨ (audit_logs)

**è¡¨è¯´æ˜**ï¼šè®°å½•ç”¨æˆ·æ“ä½œï¼Œæ»¡è¶³ä¼ä¸šåˆè§„è¦æ±‚

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ | ç´¢å¼• |
|-------|------|------|------|------|
| id | BIGINT | æ—¥å¿—ID | PK, AUTO_INCREMENT | PK |
| user_id | BIGINT | ç”¨æˆ·ID | NOT NULL, FK | FK, IDX |
| operation | VARCHAR(64) | æ“ä½œç±»å‹ | NOT NULL | IDX |
| resource | VARCHAR(256) | èµ„æºæè¿° | NOT NULL | - |
| status | ENUM('success', 'failure') | æ“ä½œç»“æœ | NOT NULL | - |
| error_msg | TEXT | é”™è¯¯ä¿¡æ¯ | DEFAULT NULL | - |
| remote_ip | VARCHAR(45) | å®¢æˆ·ç«¯IP | NOT NULL | IDX |
| user_agent | VARCHAR(256) | ç”¨æˆ·ä»£ç† | DEFAULT NULL | - |
| created_at | DATETIME | æ“ä½œæ—¶é—´ | NOT NULL, DEFAULT NOW() | IDX |

**ç´¢å¼•è®¾è®¡**ï¼š

| ç´¢å¼•å | ç±»å‹ | å­—æ®µ | ç”¨é€” |
|-------|------|------|------|
| FK idx_user_id | å¤–é”®ç´¢å¼• | user_id | æŒ‰ç”¨æˆ·æŸ¥è¯¢æ“ä½œæ—¥å¿— |
| idx_operation | æ™®é€šç´¢å¼• | operation | æŒ‰æ“ä½œç±»å‹æŸ¥è¯¢ |
| idx_created_at | æ™®é€šç´¢å¼• | created_at | æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼ˆæ—¥å¿—æ¸…ç†ï¼‰ |
| idx_user_operation | å¤åˆç´¢å¼• | user_id, created_at | æŒ‰ç”¨æˆ·å’Œæ—¶é—´æŸ¥è¯¢ |

---

### 2.1.4 ERå›¾

```mermaid
erDiagram
    USERS ||--o{ SESSIONS : has
    USERS ||--o{ AUDIT_LOGS : performs

    USERS {
        bigint id PK
        varchar username UK
        varchar home_dir
        varchar workspace_dir
        boolean is_active
        int quota_per_month
        int quota_used
        date quota_reset_date
        datetime created_at
    }

    SESSIONS {
        bigint id PK
        bigint user_id FK
        varchar conversation_id UK
        int process_id
        varchar title
        enum status
        datetime last_activity_time
        datetime created_at
    }

    AUDIT_LOGS {
        bigint id PK
        bigint user_id FK
        varchar operation
        varchar resource
        enum status
        text error_msg
        varchar remote_ip
        varchar user_agent
        datetime created_at
    }
```

---

## 2.2 APIè§„èŒƒè®¾è®¡

### 2.2.1 APIç«¯ç‚¹åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | æè¿° | æƒé™ | å…³é”®å‚æ•° |
|-----|------|------|------|---------|
| GET | /api/users/me | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ | å·²è®¤è¯ | - |
| PATCH | /api/users/me/preferences | æ›´æ–°ç”¨æˆ·åå¥½ | å·²è®¤è¯ | preferences (JSON) |
| GET | /api/users/me/quota | æŸ¥è¯¢ç”¨æˆ·é…é¢ä½¿ç”¨æƒ…å†µ | å·²è®¤è¯ | - |
| POST | /api/conversations | å¯åŠ¨æ–°å¯¹è¯ | å·²è®¤è¯ | systemPrompt, codeTemplate |
| GET | /api/conversations | è·å–ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯ | å·²è®¤è¯ | status, limit, offset |
| POST | /api/heartbeat | å‰ç«¯å¿ƒè·³ï¼ˆé˜²è¿›ç¨‹è¯¯å›æ”¶ï¼‰ | å·²è®¤è¯ | conversationId |
| GET | /health | å¥åº·æ£€æŸ¥ | å…¬å¼€ | - |

---

### 2.2.2 å…³é”®æ¥å£è®¾è®¡

#### GET /api/users/me - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**è¯·æ±‚**ï¼š
```
GET /api/users/me
Header: X-Gateway-Token: {token}
Cookie: dss_user_name=zhangsan
```

**å“åº”æ‘˜è¦**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| code | int | å“åº”ç ï¼ˆ200/401/500ï¼‰ |
| data | Object | { username, homeDir, quotaPerMonth, quotaUsed } |

---

#### POST /api/conversations - å¯åŠ¨æ–°å¯¹è¯

**è¯·æ±‚**ï¼š
```
POST /api/conversations
Header: X-Gateway-Token: {token}
Content-Type: application/json

{
  "systemPrompt": "You are a helpful assistant",
  "codeTemplate": "..."
}
```

**å“åº”æ‘˜è¦**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| conversationId | string | å¯¹è¯ID |
| processId | int | è¿›ç¨‹ID |
| status | string | 'running' |

---

#### POST /api/heartbeat - å‰ç«¯å¿ƒè·³

**è¯·æ±‚**ï¼š
```
POST /api/heartbeat
Header: X-Gateway-Token: {token}
Content-Type: application/json

{
  "conversationId": "conv-123456"
}
```

**å“åº”æ‘˜è¦**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| code | int | 200 OK |
| message | string | "heartbeat received" |

---

## 2.3 æµ‹è¯•ç­–ç•¥

### 2.3.1 æµ‹è¯•èŒƒå›´

| æµ‹è¯•ç±»å‹ | è¦†ç›–èŒƒå›´ | ä¼˜å…ˆçº§ |
|---------|---------|-------|
| å•å…ƒæµ‹è¯• | è®¤è¯ä¸­é—´ä»¶ã€ConfigServiceã€ç”¨æˆ·ç›®å½•æ˜ å°„ | P0 |
| é›†æˆæµ‹è¯• | ç”¨æˆ·éš”ç¦»ã€è¿›ç¨‹éš”ç¦»ã€ä¼šè¯éš”ç¦»ã€æƒé™éªŒè¯ | P0 |
| å‹åŠ›æµ‹è¯• | 200/500å¹¶å‘ç”¨æˆ·ã€å¯¹è¯å¯åŠ¨ååé‡ | P1 |
| å®‰å…¨æµ‹è¯• | è·¯å¾„æ³¨å…¥ã€æƒé™è¶Šæƒã€Tokenä¼ªé€  | P1 |
| å›å½’æµ‹è¯• | ç°æœ‰åŠŸèƒ½å…¼å®¹æ€§ | P0 |

### 2.3.2 å…³é”®æµ‹è¯•åœºæ™¯

| åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º | ä¼˜å…ˆçº§ |
|-----|------|---------|-------|
| è®¤è¯æˆåŠŸ | æœ‰æ•ˆToken+Cookie | req.useræ³¨å…¥æˆåŠŸï¼Œ200 OK | P0 |
| æ— Tokenè®¤è¯ | ä»…Cookieï¼Œæ— Token | 401 Unauthorized | P0 |
| ç”¨æˆ·åæ³¨å…¥ | `../../../etc/passwd` | 400 Bad Request | P0 |
| ç”¨æˆ·éš”ç¦» | ç”¨æˆ·Aè®¿é—®ç”¨æˆ·Bä¼šè¯ | 403 Forbidden | P0 |
| è¿›ç¨‹éš”ç¦»éªŒè¯ | æŸ¥çœ‹è¿›ç¨‹euid | euid=çœŸå®ç”¨æˆ·IDï¼Œéhadoop | P0 |
| æƒé™æ£€æŸ¥ | ç”¨æˆ·Aè¯»å–ç”¨æˆ·Bæ–‡ä»¶ | Permission denied | P0 |
| å¹¶å‘å¯åŠ¨ | 200ä¸ªç”¨æˆ·åŒæ—¶å¯åŠ¨å¯¹è¯ | 100%æˆåŠŸï¼Œå“åº” < 2s | P1 |
| è¿›ç¨‹å›æ”¶ | ç©ºé—²10åˆ†é’Ÿæ— æ´»åŠ¨ | è¿›ç¨‹è¢«è‡ªåŠ¨å›æ”¶ | P1 |
| å¿ƒè·³é˜²è¯¯æ€ | å‰ç«¯æ¯åˆ†é’Ÿå¿ƒè·³ | è¿›ç¨‹ä¸è¢«å›æ”¶ | P1 |

---

## 2.4 å…¼å®¹æ€§ç­–ç•¥

### æ¥å£å…¼å®¹æ€§

- **ç­–ç•¥**ï¼šä¿æŒç°æœ‰å‰ç«¯ API æ¥å£ç»“æ„ä¸å˜
- **æ–¹æ¡ˆ**ï¼š
  - ç°æœ‰æ¥å£å¢å¼ºï¼šæ·»åŠ  `user_id` éš”ç¦»ï¼Œä¿æŒå“åº”æ ¼å¼
  - æ–°å¢æ¥å£ï¼š`/api/users/*` è·¯ç”±ï¼ˆæ–°åŠŸèƒ½ï¼Œä¸å½±å“ç°æœ‰ï¼‰
- **éªŒè¯**ï¼šå‰ç«¯æ— éœ€å¤§è§„æ¨¡æ”¹åŠ¨

### é…ç½®å…¼å®¹æ€§

- **ç­–ç•¥**ï¼šä¿ç•™å•ç”¨æˆ·é…ç½®æ ¼å¼
- **æ–¹æ¡ˆ**ï¼š
  - ç³»ç»Ÿçº§é»˜è®¤é…ç½®
  - ç”¨æˆ·çº§é…ç½® `/mnt/bdap/<username>/.cui/config.json` è¦†ç›–é»˜è®¤å€¼
- **éªŒè¯**ï¼šé…ç½®åŠ è½½æµ‹è¯•

---

## 2.5 å›æ»šæ–¹æ¡ˆ

| é˜¶æ®µ | å›æ»šæ–¹æ¡ˆ | å›æ»šè§¦å‘æ¡ä»¶ | å›æ»šæ—¶é—´ |
|-----|---------|-------------|---------|
| é˜¶æ®µ1 | ç¦ç”¨è®¤è¯ä¸­é—´ä»¶ï¼Œå›æ»šæ•°æ®åº“å˜æ›´ | æ•°æ®åº“å¼‚å¸¸æˆ–è®¤è¯å¤±è´¥ | < 1å°æ—¶ |
| é˜¶æ®µ2 | æ¢å¤åŸClaudeProcessManagerï¼ˆä¸ä½¿ç”¨sudoï¼‰ | è¿›ç¨‹éš”ç¦»æ•…éšœï¼Œè¿›ç¨‹æ— æ³•å¯åŠ¨ | < 2å°æ—¶ |
| é˜¶æ®µ3 | å›æ»šè·¯ç”±æ”¹é€ ï¼Œé™çº§æœ¬åœ°è®¤è¯ | APIé›†æˆæµ‹è¯•å¤±è´¥ | < 2å°æ—¶ |
| é˜¶æ®µ4 | ç¦ç”¨è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç† | èµ„æºå›æ”¶å¼‚å¸¸ï¼Œè¿›ç¨‹è¢«è¯¯æ€ | < 1å°æ—¶ |
| é˜¶æ®µ5 | å›æ»šå‰ç«¯ç‰ˆæœ¬ | å‰ç«¯å…¼å®¹æ€§é—®é¢˜ | < 1å°æ—¶ |
| é˜¶æ®µ6 | å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬éƒ¨ç½² | ç”Ÿäº§ç¯å¢ƒP0æ•…éšœ | < 30åˆ†é’Ÿ |

**å›æ»šè§¦å‘æ¡ä»¶**ï¼š
- å›å½’æµ‹è¯•å¤±è´¥ç‡ > 5%
- ç”Ÿäº§ç¯å¢ƒå‡ºç° P0/P1 æ•…éšœ
- æ€§èƒ½ä¸‹é™ > 20%
- å®‰å…¨å®¡è®¡å‘ç°é‡å¤§æ¼æ´

---

# Part 3: å‚è€ƒèµ„æ–™

> ğŸ“ **æœ¬å±‚ç›®æ ‡**ï¼šå®Œæ•´ä»£ç ã€è„šæœ¬ã€é…ç½®ï¼ŒæŒ‰éœ€æŸ¥é˜…ã€‚
>
> **ä½¿ç”¨æ–¹å¼**ï¼šç‚¹å‡»å±•å¼€æŸ¥çœ‹è¯¦ç»†å†…å®¹

## 3.1 å®Œæ•´DDLè„šæœ¬

<details>
<summary>ğŸ“„ ç‚¹å‡»å±•å¼€ MySQL DDL å»ºè¡¨è„šæœ¬</summary>

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS cui_multi_user
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

USE cui_multi_user;

-- ===== ç”¨æˆ·è¡¨ =====
CREATE TABLE IF NOT EXISTS `users` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `username` VARCHAR(32) NOT NULL UNIQUE COMMENT 'ç”¨æˆ·å',
  `home_dir` VARCHAR(256) NOT NULL COMMENT 'ç”¨æˆ·ä¸»ç›®å½•',
  `workspace_dir` VARCHAR(256) NOT NULL COMMENT 'å·¥ä½œç›®å½•',
  `is_active` BOOLEAN NOT NULL DEFAULT 1 COMMENT 'æ˜¯å¦æ´»è·ƒ',
  `quota_per_month` INT NOT NULL DEFAULT 100 COMMENT 'æœˆåº¦é…é¢ï¼ˆå¯¹è¯æ¬¡æ•°ï¼‰',
  `quota_used` INT NOT NULL DEFAULT 0 COMMENT 'æœ¬æœˆå·²ä½¿ç”¨',
  `quota_reset_date` DATE NOT NULL COMMENT 'é…é¢é‡ç½®æ—¥æœŸ',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç³»ç»Ÿç”¨æˆ·è¡¨';

-- ===== ä¼šè¯è¡¨ =====
CREATE TABLE IF NOT EXISTS `sessions` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ä¼šè¯ID',
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `conversation_id` VARCHAR(64) NOT NULL UNIQUE COMMENT 'å¯¹è¯ID',
  `process_id` INT NOT NULL COMMENT 'è¿›ç¨‹ID',
  `title` VARCHAR(256) DEFAULT '' COMMENT 'ä¼šè¯æ ‡é¢˜',
  `status` ENUM('running', 'completed', 'error') NOT NULL COMMENT 'ä¼šè¯çŠ¶æ€',
  `last_activity_time` DATETIME NOT NULL COMMENT 'æœ€åæ´»åŠ¨æ—¶é—´',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_conversation_id` (`conversation_id`),
  KEY `fk_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_last_activity_time` (`last_activity_time`),
  KEY `idx_user_status` (`user_id`, `status`),
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·ä¼šè¯è¡¨';

-- ===== å®¡è®¡æ—¥å¿—è¡¨ =====
CREATE TABLE IF NOT EXISTS `audit_logs` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'æ—¥å¿—ID',
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `operation` VARCHAR(64) NOT NULL COMMENT 'æ“ä½œç±»å‹',
  `resource` VARCHAR(256) NOT NULL COMMENT 'èµ„æºæè¿°',
  `status` ENUM('success', 'failure') NOT NULL COMMENT 'æ“ä½œç»“æœ',
  `error_msg` TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
  `remote_ip` VARCHAR(45) NOT NULL COMMENT 'å®¢æˆ·ç«¯IP',
  `user_agent` VARCHAR(256) COMMENT 'ç”¨æˆ·ä»£ç†',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'æ“ä½œæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `fk_user_id` (`user_id`),
  KEY `idx_operation` (`operation`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_user_created` (`user_id`, `created_at`),
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å®¡è®¡æ—¥å¿—è¡¨';
```

</details>

---

## 3.2 å®Œæ•´ä»£ç ç¤ºä¾‹

<details>
<summary>ğŸ“„ gatewayAuthMiddleware.ts - ç½‘å…³è®¤è¯ä¸­é—´ä»¶å®ç°</summary>

```typescript
import { Request, Response, NextFunction } from 'express';
import { UserMappingService } from './UserMappingService';
import { UserService } from './UserService';

export class GatewayAuthMiddleware {
  constructor(
    private userMappingService: UserMappingService,
    private userService: UserService
  ) {}

  /**
   * ä¸­é—´ä»¶å¤„ç†å‡½æ•°
   */
  middleware() {
    return async (req: Request, res: Response, next: NextFunction) => {
      try {
        // 1. è¯»å– Token
        const token = req.headers['x-gateway-token'] as string;
        if (!token) {
          return res.status(401).json({ code: 401, message: 'Missing authentication token' });
        }

        // 2. è¯»å– Cookie ä¸­çš„ç”¨æˆ·å
        const username = req.cookies['dss_user_name'] as string;
        if (!username) {
          return res.status(401).json({ code: 401, message: 'Missing user context in cookie' });
        }

        // 3. éªŒè¯ç”¨æˆ·åæ ¼å¼ï¼ˆé˜²è·¯å¾„æ³¨å…¥ï¼‰
        if (!this.validateUsername(username)) {
          return res.status(400).json({ code: 400, message: 'Invalid username format' });
        }

        // 4. æŸ¥è¯¢ç”¨æˆ·æ˜ å°„å’Œæƒé™
        const userMapping = await this.userMappingService.getUserMapping(username);
        if (!userMapping) {
          return res.status(401).json({ code: 401, message: 'User not found or directory missing' });
        }

        // 5. æŸ¥è¯¢æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
        const user = await this.userService.getUserByUsername(username);
        if (!user || !user.is_active) {
          return res.status(401).json({ code: 401, message: 'User inactive' });
        }

        // 6. æ³¨å…¥ç”¨æˆ·ä¸Šä¸‹æ–‡åˆ° req.user
        req.user = {
          id: user.id,
          username: user.username,
          homeDir: userMapping.homeDir,
          workspaceDir: userMapping.workspaceDir,
          claudeDir: userMapping.claudeDir,
          cuiDir: userMapping.cuiDir,
        };

        next();
      } catch (error) {
        console.error('Authentication middleware error:', error);
        return res.status(500).json({ code: 500, message: 'Internal server error' });
      }
    };
  }

  /**
   * éªŒè¯ç”¨æˆ·åæ ¼å¼
   * ä»…å…è®¸ï¼šå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
   * é•¿åº¦ï¼š1-32
   */
  private validateUsername(username: string): boolean {
    const pattern = /^[a-zA-Z0-9_]{1,32}$/;
    return pattern.test(username);
  }
}
```

</details>

<details>
<summary>ğŸ“„ ClaudeProcessManager.ts - å¢å¼ºçš„è¿›ç¨‹ç®¡ç†å™¨ï¼ˆsudoéš”ç¦»ï¼‰</summary>

```typescript
import { spawn } from 'child_process';
import { ConfigService } from './ConfigService';
import { UserMappingService } from './UserMappingService';

export interface MultiUserConversationConfig {
  systemPrompt?: string;
  codeTemplate?: string;
  userContext: {
    username: string;
    homeDir: string;
    workspaceDir: string;
    claudeDir: string;
    cuiDir: string;
  };
}

export class ClaudeProcessManager {
  private processMap = new Map<number, ProcessInfo>();

  constructor(
    private configService: ConfigService,
    private userMappingService: UserMappingService
  ) {}

  /**
   * å¯åŠ¨ç”¨æˆ·å¯¹è¯
   * æ ¸å¿ƒï¼šä½¿ç”¨ sudo -u <username> åˆ‡æ¢ç”¨æˆ·å¯åŠ¨è¿›ç¨‹
   */
  async startConversation(config: MultiUserConversationConfig): Promise<{
    conversationId: string;
    processInfo: ProcessInfo;
  }> {
    const { username, workspaceDir, claudeDir } = config.userContext;

    try {
      // 1. åŠ è½½ç”¨æˆ·é…ç½®
      const userConfig = await this.configService.loadUserConfig(
        username,
        `${config.userContext.homeDir}/.cui`
      );

      // 2. æ„å»ºå¯åŠ¨å‘½ä»¤
      const args = ['--cwd', workspaceDir];
      if (config.systemPrompt) {
        args.push('--system-prompt', config.systemPrompt);
      }

      // 3. ä½¿ç”¨ sudo -u <username> åˆ‡æ¢ç”¨æˆ·å¯åŠ¨è¿›ç¨‹
      const proc = spawn('sudo', [
        '-u',
        username,           // åˆ‡æ¢åˆ°çœŸå®ç”¨æˆ·
        '-i',               // åŠ è½½ç”¨æˆ·çš„å®Œæ•´ç™»å½•ç¯å¢ƒ
        '--',               // åé¢çš„å‘½ä»¤ä¸å†è¢«sudoè§£æä¸ºé€‰é¡¹
        'claude',
        ...args,
      ], {
        cwd: workspaceDir,
        env: {
          ...process.env,
          HOME: config.userContext.homeDir,  // è¦†ç›–HOMEï¼Œç¡®ä¿ä½¿ç”¨ç”¨æˆ·ç›®å½•
          CLAUDE_PROJECTS_DIR: claudeDir,
        },
        stdio: ['pipe', 'pipe', 'pipe'],  // ç®¡ç† stdin/stdout/stderr
      });

      // 4. å¤„ç†è¿›ç¨‹äº‹ä»¶
      const processId = proc.pid!;
      const conversationId = `conv-${username}-${Date.now()}-${processId}`;

      const processInfo: ProcessInfo = {
        pid: processId,
        username,
        conversationId,
        euid: null,  // å¾…æ›´æ–°
        lastActivityTime: Date.now(),
        createdAt: Date.now(),
      };

      // 5. è®°å½•è¿›ç¨‹æ˜ å°„
      this.processMap.set(processId, processInfo);

      // 6. ç›‘å¬è¿›ç¨‹é€€å‡º
      proc.on('exit', (code, signal) => {
        console.log(`Process ${processId} exited with code ${code}, signal ${signal}`);
        this.processMap.delete(processId);
      });

      // 7. å¤„ç† stdout/stderrï¼Œé‡å®šå‘åˆ°ç”¨æˆ·æ—¥å¿—ç›®å½•
      const logPath = `${config.userContext.cuiDir}/logs/claude-cli-${new Date().toISOString()}.log`;
      proc.stdout?.pipe(this.createLogStream(logPath));
      proc.stderr?.pipe(this.createLogStream(logPath));

      return {
        conversationId,
        processInfo,
      };
    } catch (error) {
      console.error(`Failed to start conversation for user ${username}:`, error);
      throw error;
    }
  }

  /**
   * è·å–ç”¨æˆ·çš„æ‰€æœ‰è¿›ç¨‹
   */
  getProcessesByUser(username: string): ProcessInfo[] {
    return Array.from(this.processMap.values())
      .filter(p => p.username === username);
  }

  /**
   * æ›´æ–°è¿›ç¨‹æ´»åŠ¨æ—¶é—´ï¼ˆå¿ƒè·³ï¼‰
   */
  updateProcessActivity(conversationId: string): void {
    for (const processInfo of this.processMap.values()) {
      if (processInfo.conversationId === conversationId) {
        processInfo.lastActivityTime = Date.now();
        break;
      }
    }
  }

  /**
   * ç»ˆæ­¢è¿›ç¨‹
   */
  async terminateProcess(pid: number): Promise<void> {
    const processInfo = this.processMap.get(pid);
    if (!processInfo) {
      throw new Error(`Process ${pid} not found`);
    }

    try {
      process.kill(pid, 'SIGTERM');
      // ç­‰å¾…è¿›ç¨‹é€€å‡ºï¼Œ5ç§’åå¼ºåˆ¶SIGKILL
      await new Promise(resolve => setTimeout(resolve, 5000));
      if (this.processMap.has(pid)) {
        process.kill(pid, 'SIGKILL');
      }
    } catch (error) {
      console.error(`Failed to terminate process ${pid}:`, error);
    }
  }

  private createLogStream(logPath: string) {
    // å®ç°æ—¥å¿—æµåˆ›å»ºé€»è¾‘
    // å¯ä»¥ä½¿ç”¨ fs.createWriteStream(logPath)
    return process.stdout;  // ç®€åŒ–ç¤ºä¾‹
  }
}

export interface ProcessInfo {
  pid: number;
  username: string;
  conversationId: string;
  euid: number | null;
  lastActivityTime: number;  // æ¯«ç§’
  createdAt: number;         // æ¯«ç§’
}
```

</details>

<details>
<summary>ğŸ“„ ConfigService.ts - å¤šç”¨æˆ·é…ç½®æœåŠ¡</summary>

```typescript
import * as fs from 'fs/promises';
import * as path from 'path';

export interface CUIConfig {
  apiKey: string;
  models: string[];
  defaultModel: string;
  timeout: number;
  [key: string]: any;
}

export class ConfigService {
  private configCache = new Map<string, CUIConfig>();
  private readonly CONFIG_FILE_NAME = 'config.json';
  private readonly CACHE_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜
  private cacheTimestamp = new Map<string, number>();

  /**
   * åŠ è½½ç”¨æˆ·é…ç½®
   * ä» /mnt/bdap/<username>/.cui/config.json è¯»å–
   * å¦‚æœä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
   */
  async loadUserConfig(username: string, userCuiDir: string): Promise<CUIConfig> {
    // 1. æ£€æŸ¥ç¼“å­˜
    const cached = this.getCachedConfig(username);
    if (cached) {
      return cached;
    }

    try {
      // 2. è¯»å–ç”¨æˆ·é…ç½®æ–‡ä»¶
      const configPath = path.join(userCuiDir, this.CONFIG_FILE_NAME);
      const configContent = await fs.readFile(configPath, 'utf-8');
      const config: CUIConfig = JSON.parse(configContent);

      // 3. ç¼“å­˜é…ç½®
      this.configCache.set(username, config);
      this.cacheTimestamp.set(username, Date.now());

      return config;
    } catch (error) {
      if ((error as any).code === 'ENOENT') {
        // 4. æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
        console.warn(`Config file not found for user ${username}, using defaults`);
        return this.getDefaultConfig();
      }
      throw error;
    }
  }

  /**
   * è·å–ç¼“å­˜çš„é…ç½®ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
   */
  getCachedConfig(username: string): CUIConfig | null {
    const cached = this.configCache.get(username);
    if (!cached) {
      return null;
    }

    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
    const timestamp = this.cacheTimestamp.get(username) || 0;
    if (Date.now() - timestamp > this.CACHE_TTL) {
      this.configCache.delete(username);
      this.cacheTimestamp.delete(username);
      return null;
    }

    return cached;
  }

  /**
   * æ¸…é™¤ç”¨æˆ·é…ç½®ç¼“å­˜
   */
  clearUserCache(username: string): void {
    this.configCache.delete(username);
    this.cacheTimestamp.delete(username);
  }

  /**
   * è·å–é»˜è®¤é…ç½®
   */
  private getDefaultConfig(): CUIConfig {
    return {
      apiKey: process.env.CLAUDE_API_KEY || '',
      models: ['claude-3-opus', 'claude-3-sonnet'],
      defaultModel: 'claude-3-opus',
      timeout: 60000,
    };
  }
}
```

</details>

---

## 3.3 éƒ¨ç½²è„šæœ¬

<details>
<summary>ğŸ“„ verify-sudo-config.sh - éªŒè¯ sudo æƒé™é…ç½®</summary>

```bash
#!/bin/bash

# éªŒè¯ CUI Server çš„ sudo æƒé™é…ç½®
# åœ¨æœåŠ¡å™¨éƒ¨ç½²å‰è¿è¡Œæ­¤è„šæœ¬

set -e

echo "========================================="
echo "CUI å¤šç”¨æˆ·æ¶æ„ - Sudoæƒé™éªŒè¯è„šæœ¬"
echo "========================================="

# æ£€æŸ¥å½“å‰ç”¨æˆ·
CURRENT_USER=$(whoami)
echo "[1] å½“å‰ç”¨æˆ·: $CURRENT_USER"

# æ£€æŸ¥æ˜¯å¦å¯ä»¥ sudo åˆ°å…¶ä»–ç”¨æˆ·
TEST_USER="testuser"
echo "[2] æ£€æŸ¥ sudo -u æƒé™..."

# å°è¯•ä»¥ testuser èº«ä»½æ‰§è¡Œ id å‘½ä»¤
if sudo -u $TEST_USER id > /dev/null 2>&1; then
  echo "  âœ… å¯ä»¥ sudo -u $TEST_USER æ‰§è¡Œå‘½ä»¤"
else
  echo "  âŒ æ— æ³• sudo -u $TEST_USER"
  echo "  è§£å†³æ–¹æ¡ˆ: åœ¨ /etc/sudoers ä¸­æ·»åŠ :"
  echo "  hadoop ALL=(ALL) NOPASSWD: /usr/bin/claude"
  exit 1
fi

# æ£€æŸ¥ NOPASSWD æƒé™
echo "[3] æ£€æŸ¥ NOPASSWD æƒé™..."
if sudo -l 2>/dev/null | grep -q "NOPASSWD"; then
  echo "  âœ… å·²é…ç½® NOPASSWD æƒé™"
else
  echo "  âš ï¸  æœªæ£€æµ‹åˆ° NOPASSWDï¼Œå¯èƒ½éœ€è¦è¾“å…¥å¯†ç "
fi

# éªŒè¯ç”¨æˆ·ç›®å½•æƒé™
echo "[4] æ£€æŸ¥ç”¨æˆ·ç›®å½•æƒé™..."
for user_dir in /mnt/bdap/*/; do
  if [ -d "$user_dir" ]; then
    perm=$(stat -c %a "$user_dir")
    owner=$(stat -c %U "$user_dir")
    if [ "$perm" = "700" ]; then
      echo "  âœ… $user_dir æƒé™æ­£ç¡® ($perm, owner: $owner)"
    else
      echo "  âš ï¸  $user_dir æƒé™ä¸è§„èŒƒ (å½“å‰: $perm, æœŸæœ›: 700)"
    fi
  fi
done

echo ""
echo "========================================="
echo "âœ… Sudo æƒé™éªŒè¯å®Œæˆ"
echo "========================================="
```

</details>

<details>
<summary>ğŸ“„ init-user-environment.sh - åˆå§‹åŒ–ç”¨æˆ·ç¯å¢ƒï¼ˆè¿ç»´è„šæœ¬ï¼‰</summary>

```bash
#!/bin/bash

# åˆå§‹åŒ– CUI å¤šç”¨æˆ·ç¯å¢ƒï¼ˆè¿ç»´ä½¿ç”¨ï¼‰
# ä¸ºæ–°ç”¨æˆ·åˆ›å»ºç›®å½•ç»“æ„å’Œæƒé™

set -e

USERNAME=$1
BASE_DIR="/mnt/bdap"

if [ -z "$USERNAME" ]; then
  echo "Usage: $0 <username>"
  echo "Example: $0 zhangsan"
  exit 1
fi

echo "åˆå§‹åŒ–ç”¨æˆ· $USERNAME çš„ç¯å¢ƒ..."

# 1. åˆ›å»ºç”¨æˆ·ä¸»ç›®å½•
USER_DIR="$BASE_DIR/$USERNAME"
if [ ! -d "$USER_DIR" ]; then
  mkdir -p "$USER_DIR"
  echo "âœ… åˆ›å»ºç›®å½•: $USER_DIR"
else
  echo "âš ï¸  ç›®å½•å·²å­˜åœ¨: $USER_DIR"
fi

# 2. åˆ›å»ºå­ç›®å½•
mkdir -p "$USER_DIR/workspace"
mkdir -p "$USER_DIR/.claude/projects"
mkdir -p "$USER_DIR/.cui/logs"
mkdir -p "$USER_DIR/.cui/config"
echo "âœ… åˆ›å»ºå­ç›®å½•"

# 3. è®¾ç½®ç›®å½•æƒé™ï¼ˆ700 = ä»…æ‰€æœ‰è€…å¯è®¿é—®ï¼‰
chown -R "$USERNAME:$USERNAME" "$USER_DIR"
chmod 700 "$USER_DIR"
chmod 700 "$USER_DIR/workspace"
chmod 700 "$USER_DIR/.claude"
chmod 700 "$USER_DIR/.cui"
echo "âœ… è®¾ç½®ç›®å½•æƒé™ (700)"

# 4. åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CONFIG_FILE="$USER_DIR/.cui/config.json"
if [ ! -f "$CONFIG_FILE" ]; then
  cat > "$CONFIG_FILE" << 'EOF'
{
  "apiKey": "${CLAUDE_API_KEY}",
  "models": ["claude-3-opus", "claude-3-sonnet"],
  "defaultModel": "claude-3-opus",
  "timeout": 60000
}
EOF
  chmod 600 "$CONFIG_FILE"
  chown "$USERNAME:$USERNAME" "$CONFIG_FILE"
  echo "âœ… åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
else
  echo "âš ï¸  é…ç½®æ–‡ä»¶å·²å­˜åœ¨: $CONFIG_FILE"
fi

echo ""
echo "========================================="
echo "âœ… ç”¨æˆ·ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
echo "========================================="
echo "ç”¨æˆ·ç›®å½•: $USER_DIR"
echo "å·¥ä½œåŒº: $USER_DIR/workspace"
echo "é…ç½®æ–‡ä»¶: $CONFIG_FILE"
echo ""
```

</details>

---

## 3.4 å¿ƒè·³æœºåˆ¶å®ç°

<details>
<summary>ğŸ“„ å‰ç«¯å¿ƒè·³å®ç°ç¤ºä¾‹</summary>

```typescript
// å‰ç«¯å¿ƒè·³æœºåˆ¶
// é˜²æ­¢è¿›ç¨‹åœ¨ç”¨æˆ·æ­£åœ¨ä½¿ç”¨æ—¶è¢«è¯¯å›æ”¶

export class ConversationHeartbeat {
  private heartbeatInterval: NodeJS.Timeout | null = null;
  private readonly HEARTBEAT_INTERVAL = 60 * 1000; // 1åˆ†é’Ÿå‘ä¸€æ¬¡å¿ƒè·³

  /**
   * å¯åŠ¨å¿ƒè·³
   */
  startHeartbeat(conversationId: string, apiClient: ApiClient): void {
    this.stopHeartbeat();  // æ¸…ç†æ—§çš„å¿ƒè·³

    this.heartbeatInterval = setInterval(async () => {
      try {
        await apiClient.post('/api/heartbeat', {
          conversationId,
        });
        console.log(`[Heartbeat] Sent heartbeat for conversation ${conversationId}`);
      } catch (error) {
        console.error(`[Heartbeat] Failed to send heartbeat:`, error);
        // å¿ƒè·³å¤±è´¥ä¸ä¸­æ­¢æµç¨‹ï¼Œç»§ç»­é‡è¯•
      }
    }, this.HEARTBEAT_INTERVAL);
  }

  /**
   * åœæ­¢å¿ƒè·³
   */
  stopHeartbeat(): void {
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
      this.heartbeatInterval = null;
    }
  }
}

// åœ¨å¯¹è¯å¼€å§‹æ—¶å¯åŠ¨å¿ƒè·³
const heartbeat = new ConversationHeartbeat();

async function startConversation(prompt: string) {
  const response = await apiClient.post('/api/conversations', { prompt });
  const { conversationId } = response;

  // å¯åŠ¨å¿ƒè·³ï¼Œé˜²æ­¢è¿›ç¨‹è¢«å›æ”¶
  heartbeat.startHeartbeat(conversationId, apiClient);

  // å»ºç«‹ SSE è¿æ¥ç›‘å¬å¯¹è¯
  return connectToConversation(conversationId);
}
```

</details>

---

## 3.5 è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†å®ç°

<details>
<summary>ğŸ“„ ProcessLifecycleManager.ts - è¿›ç¨‹å›æ”¶ç®¡ç†</summary>

```typescript
import { ClaudeProcessManager, ProcessInfo } from './ClaudeProcessManager';

export class ProcessLifecycleManager {
  private readonly IDLE_TIMEOUT = 10 * 60 * 1000; // 10åˆ†é’Ÿ
  private readonly MAX_PROCESSES = 100;
  private readonly SCAN_INTERVAL = 60 * 1000; // 1åˆ†é’Ÿæ‰«æä¸€æ¬¡

  private scanTimerInterval: NodeJS.Timeout | null = null;

  constructor(private processManager: ClaudeProcessManager) {}

  /**
   * å¯åŠ¨è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
   */
  start(): void {
    this.scanTimerInterval = setInterval(() => {
      this.scanAndRecycleIdleProcesses();
      this.enforceMaxProcessLimit();
    }, this.SCAN_INTERVAL);

    console.log('[ProcessLifecycleManager] Started, scan interval:', this.SCAN_INTERVAL);
  }

  /**
   * åœæ­¢ç”Ÿå‘½å‘¨æœŸç®¡ç†
   */
  stop(): void {
    if (this.scanTimerInterval) {
      clearInterval(this.scanTimerInterval);
      this.scanTimerInterval = null;
    }
    console.log('[ProcessLifecycleManager] Stopped');
  }

  /**
   * æ‰«æå¹¶å›æ”¶ç©ºé—²è¿›ç¨‹
   */
  private scanAndRecycleIdleProcesses(): void {
    const now = Date.now();
    const processes = this.processManager.getAllProcesses();

    for (const processInfo of processes) {
      const idleTime = now - processInfo.lastActivityTime;

      // è¶…è¿‡10åˆ†é’Ÿæ— æ´»åŠ¨ï¼Œå›æ”¶è¿›ç¨‹
      if (idleTime > this.IDLE_TIMEOUT) {
        console.log(
          `[ProcessLifecycleManager] Recycling idle process ${processInfo.pid} (idle for ${idleTime}ms)`
        );
        this.processManager.terminateProcess(processInfo.pid).catch(error => {
          console.error(`[ProcessLifecycleManager] Failed to terminate process ${processInfo.pid}:`, error);
        });
      }
    }
  }

  /**
   * å¼ºåˆ¶LRUæ·˜æ±°ï¼Œä¿è¯è¿›ç¨‹æ•°ä¸è¶…è¿‡ä¸Šé™
   */
  private enforceMaxProcessLimit(): void {
    const processes = this.processManager.getAllProcesses();

    if (processes.length > this.MAX_PROCESSES) {
      // æŒ‰æœ€åæ´»åŠ¨æ—¶é—´æ’åºï¼ˆæ—©çš„åœ¨å‰ï¼‰
      const sorted = processes.sort((a, b) => a.lastActivityTime - b.lastActivityTime);

      // å›æ”¶ "æœ€ä¹…æœªæ´»åŠ¨" çš„è¿›ç¨‹
      const toRecycle = sorted.slice(0, processes.length - this.MAX_PROCESSES);

      for (const processInfo of toRecycle) {
        console.log(
          `[ProcessLifecycleManager] Recycling LRU process ${processInfo.pid} (total: ${processes.length})`
        );
        this.processManager.terminateProcess(processInfo.pid).catch(error => {
          console.error(`[ProcessLifecycleManager] Failed to terminate LRU process ${processInfo.pid}:`, error);
        });
      }
    }
  }
}
```

</details>

---

## 3.6 Systemd æœåŠ¡é…ç½®

<details>
<summary>ğŸ“„ cui-server.service - Systemd æœåŠ¡æ–‡ä»¶</summary>

```ini
[Unit]
Description=CUI Multi-User Web Server
Documentation=https://github.com/xxx/cui
After=network-online.target
Wants=network-online.target

[Service]
# ä»¥ hadoop ç”¨æˆ·è¿è¡Œï¼ˆsudo æƒé™ç”¨æˆ·ï¼‰
User=hadoop
Group=hadoop

# å·¥ä½œç›®å½•
WorkingDirectory=/opt/cui

# å¯åŠ¨å‘½ä»¤
ExecStart=/usr/bin/node /opt/cui/dist/index.js

# ç¯å¢ƒå˜é‡
EnvironmentFile=/etc/cui/server.env
Environment="NODE_ENV=production"
Environment="LOG_LEVEL=info"

# è¿›ç¨‹ç®¡ç†
Type=simple
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

# èµ„æºé™åˆ¶
LimitNOFILE=65536
LimitNPROC=4096

# ä¼˜é›…å…³é—­
TimeoutStopSec=30
KillMode=mixed
KillSignal=SIGTERM

# å®‰å…¨è®¾ç½®
PrivateTmp=yes
NoNewPrivileges=yes

[Install]
WantedBy=multi-user.target
```

</details>

<details>
<summary>ğŸ“„ /etc/sudoers.d/cui - Sudo æƒé™é…ç½®</summary>

```
# CUI Server sudo æƒé™é…ç½®
# å…è®¸ hadoop ç”¨æˆ·ä»¥å…¶ä»–ç”¨æˆ·èº«ä»½å¯åŠ¨ Claude CLI

# ç¦ç”¨å¯†ç æç¤ºï¼ˆNOPASSWDï¼‰
Defaults:hadoop !requiretty
Defaults:hadoop !lecture = "always"

# å…è®¸ hadoop ç”¨æˆ·ä»¥ä»»ä½•ç”¨æˆ·èº«ä»½å¯åŠ¨ /usr/bin/claude
hadoop ALL=(ALL) NOPASSWD: /usr/bin/claude

# å…è®¸ hadoop ç”¨æˆ·ä»¥ä»»ä½•ç”¨æˆ·èº«ä»½åˆ‡æ¢ç™»å½•ç¯å¢ƒï¼ˆsudo -iï¼‰
hadoop ALL=(ALL) NOPASSWD: /bin/bash -i --
```

</details>

---

## 3.7 Nginx åå‘ä»£ç†é…ç½®

<details>
<summary>ğŸ“„ nginx.conf - åå‘ä»£ç†é…ç½®ï¼ˆSSEæ”¯æŒï¼‰</summary>

```nginx
server {
    listen 443 ssl http2;
    server_name cui.example.com;

    ssl_certificate /etc/ssl/certs/cui.crt;
    ssl_certificate_key /etc/ssl/private/cui.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        access_log off;
        proxy_pass http://cui_backend:3000;
    }

    # API ç«¯ç‚¹ï¼ˆæ”¯æŒ SSEï¼‰
    location /api {
        proxy_pass http://cui_backend:3000;

        # SSE è¿æ¥é…ç½®
        proxy_buffering off;                     # å…³é—­ç¼“å†²ï¼Œå®æ—¶è½¬å‘æ•°æ®
        proxy_cache off;                         # å…³é—­ç¼“å­˜
        proxy_redirect off;

        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 600s;                 # é•¿è¿æ¥æ”¯æŒ

        # Header ä¼ é€’
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "upgrade";
        proxy_set_header Upgrade $http_upgrade;

        # èº«ä»½éªŒè¯ Headerï¼ˆç”±ç½‘å…³æ³¨å…¥ï¼‰
        proxy_set_header X-Gateway-Token $http_x_gateway_token;
        proxy_set_header Cookie $http_cookie;
    }

    # é™æ€æ–‡ä»¶
    location / {
        proxy_pass http://cui_backend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

upstream cui_backend {
    server localhost:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}
```

</details>

---

# é™„å½•

## A. ç›¸å…³æ–‡æ¡£

- [éœ€æ±‚æ–‡æ¡£](../requirements/å¤šç”¨æˆ·æ¶æ„æ”¹é€ _éœ€æ±‚.md)
- [å¤šç”¨æˆ·æ”¹é€ è®¡åˆ’V2](../../multi-user-migration-plan.md)

## B. æœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ |
|-----|------|
| **ç½‘å…³ç»Ÿä¸€è®¤è¯** | ä¼ä¸šç»Ÿä¸€ç½‘å…³å®Œæˆç”¨æˆ·ç™»å½•ï¼Œé€šè¿‡ Header æ³¨å…¥ Token å’Œ Cookie |
| **è¿›ç¨‹éš”ç¦»** | ä½¿ç”¨ `sudo -u <username>` åˆ‡æ¢ç”¨æˆ·ï¼Œè¿›ç¨‹ä»¥çœŸå®ç”¨æˆ·èº«ä»½è¿è¡Œ |
| **ç”¨æˆ·ä¸Šä¸‹æ–‡** | `req.user` å¯¹è±¡ï¼ŒåŒ…å« usernameã€homeDirã€workspaceDir ç­‰ä¿¡æ¯ |
| **è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†** | ç©ºé—²å›æ”¶ï¼ˆ10åˆ†é’Ÿï¼‰ã€è¿æ¥æ–­å¼€å›æ”¶ã€LRUæ·˜æ±°ã€å¿ƒè·³é˜²è¯¯æ€ |
| **é…é¢ç®¡ç†** | é™åˆ¶å•ç”¨æˆ·æ¯æœˆå¯¹è¯æ¬¡æ•°ï¼Œé˜²æ­¢èµ„æºæ»¥ç”¨ |
| **å®¡è®¡æ—¥å¿—** | è®°å½•ç”¨æˆ·å…³é”®æ“ä½œï¼ˆå¯åŠ¨å¯¹è¯ã€æ‰§è¡Œå‘½ä»¤ï¼‰ï¼Œæ»¡è¶³ä¼ä¸šåˆè§„ |

## C. æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¶é—´ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|---------|
| v1.0 | 2025-12-11 | Claude Agent | åˆç‰ˆåˆ›å»ºï¼ŒåŒ…å«6é˜¶æ®µè¿ç§»è®¡åˆ’ã€æ ¸å¿ƒè®¾è®¡ã€APIè§„èŒƒã€æµ‹è¯•ç­–ç•¥ |

---

**æ–‡æ¡£ç»“æŸ**

> æœ¬è®¾è®¡æ–‡æ¡£éµå¾ª REFACTOR ç±»å‹çš„åˆ†å±‚è§„èŒƒï¼ŒåŒ…å«ï¼š
> - ğŸ“‹ **æ‰§è¡Œæ‘˜è¦**ï¼š1é¡µæ¦‚è§ˆï¼ˆæ ¸å¿ƒè®¾è®¡å†³ç­–ã€å…³é”®é£é™©ã€æŒ‡æ ‡ã€ç« èŠ‚å¯¼èˆªï¼‰
> - ğŸ¯ **Part 1 æ ¸å¿ƒè®¾è®¡**ï¼šç›®æ ‡æ¶æ„ã€å¼€å‘è®¡åˆ’ã€æ ¸å¿ƒæµç¨‹ã€æ¥å£å®šä¹‰ã€ADR
> - ğŸ“ **Part 2 æ”¯æ’‘è®¾è®¡**ï¼šæ•°æ®æ¨¡å‹ã€APIè§„èŒƒã€æµ‹è¯•ç­–ç•¥ã€å…¼å®¹æ€§ã€å›æ»šæ–¹æ¡ˆ
> - ğŸ“ **Part 3 å‚è€ƒèµ„æ–™**ï¼šå®Œæ•´ä»£ç ã€è„šæœ¬ã€é…ç½®ï¼ˆæŠ˜å å±•ç¤ºï¼‰
>
> **å…³é”®äº¤ä»˜ç‰©**ï¼š
> - âœ… æ¸è¿›å¼å¼€å‘è®¡åˆ’ï¼ˆ6ä¸ªé˜¶æ®µï¼Œ1.5-2.5ä¸ªæœˆï¼‰
> - âœ… è¿›ç¨‹éš”ç¦»æ–¹æ¡ˆï¼ˆsudo -u åˆ‡æ¢ç”¨æˆ·ï¼‰
> - âœ… ç½‘å…³è®¤è¯ä¸­é—´ä»¶
> - âœ… æ•°æ®åº“æ¶æ„ï¼ˆuser_id éš”ç¦»ï¼‰
> - âœ… å›æ»šæ–¹æ¡ˆï¼ˆæ¯é˜¶æ®µç‹¬ç«‹å›æ»šï¼‰
> - âœ… å®Œæ•´æµ‹è¯•è¦†ç›–ï¼ˆå•å…ƒã€é›†æˆã€å‹åŠ›ã€å®‰å…¨ï¼‰
