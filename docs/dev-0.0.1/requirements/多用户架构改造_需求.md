# CUI多用户架构改造 重构需求文档

**需求类型**: REFACTOR（架构重构）
**重构策略**: 渐进式重构
**文档版本**: v1.0
**创建日期**: 2025-12-11
**项目**: CUI (Claude Code Web UI Platform)
**当前分支**: dev-0.0.1

---

## 📋 重构速览

| 维度 | 内容 |
|-----|------|
| **重构目标** | 将单用户应用改造为支持2000用户规模的企业多用户系统 |
| **重构类型** | 架构模式变更（单用户 → 多用户隔离） |
| **技术债务** | 单用户架构限制：全局共享配置、无用户隔离、无认证机制 |
| **重构策略** | 渐进式重构（6个阶段，7-11周） |
| **预期收益** | 支持企业级多用户并发，完全数据隔离，符合安全合规要求 |
| **涉及模块** | 认证层、进程管理、配置服务、数据库层、前端路由 |

> 💡 **阅读指引**：速览目标看本卡片 → 现状诊断看第2章 → 重构方案看第4章 → 技术实现看设计文档

---

## 1. 需求概述【核心】

### 1.1 重构背景

CUI (Claude Code Web UI) 是基于 Claude Code CLI 的 Web UI 代理平台，当前为**单用户架构**：
- 设计用于开发者个人使用
- 配置存储在 `~/.cui/config.json`（单机用户目录）
- 无多用户隔离机制
- 无企业级认证系统

**业务驱动**：企业内部需要部署 CUI 作为团队级 AI 辅助工具，支持 2000 名员工使用，要求：
- 用户数据完全隔离
- 与企业 AD 域认证集成
- 满足安全合规要求（审计日志、权限控制）
- 支持 200-500 并发用户

### 1.2 重构目标

**核心目标**：将 CUI 从**单用户桌面应用**改造为**企业级多用户 Web 服务**

**具体目标**：
1. **用户隔离**：每个用户独立的配置、会话、工作区，物理隔离
2. **认证集成**：通过企业统一网关认证（简化：网关注入Token + Cookie）
3. **进程隔离**：使用 `sudo -u <username>` 切换到真实用户身份运行 Claude CLI
4. **数据隔离**：数据库按 user_id 隔离，文件系统按 Linux 权限隔离
5. **可扩展性**：支持 2000 用户总量，200-500 并发

### 1.3 成功标准

| 维度 | 当前值 | 目标值 | 验收标准 |
|-----|-------|-------|---------|
| 并发用户数 | 1 | 200-500 | 压测验证 |
| 总用户数 | 1 | 2000 | 数据库容量验证 |
| 用户隔离性 | 无隔离 | 完全隔离 | 安全审计通过 |
| 认证方式 | 无认证 | 网关统一认证 | 集成测试通过 |
| 进程隔离 | 共享进程 | 独立用户进程 | 权限审计通过 |

---

## 2. 现状诊断【核心】

### 2.1 技术栈分析

**当前技术栈**（基于 package.json 和源码分析）：
- **后端框架**：Node.js 20+ + Express 4.18
- **前端框架**：React 18 + React Router 6 + Vite 7
- **核心依赖**：@anthropic-ai/claude-code 1.0.70
- **数据库**：better-sqlite3（SQLite本地数据库）
- **认证**：简单 Bearer Token（存储在 `~/.cui/config.json`）

### 2.2 技术债务清单

#### 架构层面

| 债务ID | 问题类型 | 问题描述 | 影响范围 | 严重度 |
|--------|---------|---------|---------|:------:|
| D1 | 单用户架构 | ConfigService 从 `~/.cui/config.json` 读取全局配置，无用户维度 | 全局 | 高 |
| D2 | 无认证系统 | 仅依赖单一 Bearer Token，无用户身份识别 | 安全 | 高 |
| D3 | 数据库限制 | 使用 SQLite 本地文件数据库，无法支持多用户并发写入 | 数据层 | 高 |
| D4 | 进程共享 | ClaudeProcessManager 以当前用户身份启动所有 Claude CLI 进程 | 进程管理 | 高 |
| D5 | 配置耦合 | ConfigService 为单例模式，全局共享配置，无法按用户加载 | 配置层 | 中 |

#### 代码层面

| 债务ID | 问题类型 | 问题描述 | 影响范围 | 严重度 |
|--------|---------|---------|---------|:------:|
| D6 | 硬编码路径 | `~/.cui/config.json` 硬编码在 ConfigService 中 | ConfigService | 中 |
| D7 | 全局状态 | SessionInfoService 存储在单一 SQLite 文件，无用户隔离 | 会话管理 | 高 |
| D8 | 权限混乱 | 所有用户的文件操作权限相同，无法区分用户 | FileSystemService | 高 |

#### 安全层面

| 债务ID | 问题类型 | 问题描述 | 影响范围 | 严重度 |
|--------|---------|---------|---------|:------:|
| D9 | 无审计日志 | 缺少用户操作审计记录 | 安全合规 | 中 |
| D10 | 无配额管理 | 无法限制单用户资源使用 | 资源管理 | 中 |
| D11 | Token泄露风险 | Bearer Token 明文存储在配置文件 | 安全 | 中 |

### 2.3 痛点量化

| 痛点 | 量化指标 | 当前值 | 期望值 | 影响 |
|-----|---------|-------|-------|-----|
| 并发限制 | 最大并发用户数 | 1 | 200-500 | 无法企业级部署 |
| 数据隔离 | 用户数据隔离程度 | 0%（共享） | 100%（完全隔离） | 安全合规风险 |
| 认证安全 | 认证方式 | 单一Token | AD域认证 | 无法集成企业身份体系 |
| 进程安全 | 进程隔离程度 | 0%（共享） | 100%（独立用户） | 权限泄露风险 |
| 可扩展性 | 支持用户数 | 1 | 2000 | 无法规模化 |

---

## 3. 收益评估【核心】

### 3.1 量化收益

| 维度 | 当前值 | 目标值 | 改进幅度 |
|-----|-------|-------|---------|
| 并发能力 | 1用户 | 200-500用户 | +20000%~50000% |
| 部署成本 | 每人1台服务器 | 全员共享1台 | -99.95% |
| 数据安全 | 无隔离 | 完全隔离 | 满足企业合规 |
| 认证集成 | 无集成 | AD域集成 | 统一身份管理 |
| 维护成本 | 分散维护 | 统一管理 | -90% |

### 3.2 业务价值

**对企业的价值**：
1. **成本节约**：从"每人一套环境"到"全员共享"，节省 99%+ 基础设施成本
2. **安全合规**：满足企业安全审计要求（用户隔离、操作审计、权限控制）
3. **管理简化**：统一部署、统一配置、统一监控
4. **快速推广**：员工无需安装配置，浏览器访问即可使用

**对用户的价值**：
1. **零配置使用**：无需本地安装 Claude CLI 和 Node.js 环境
2. **跨设备访问**：通过浏览器在任何设备使用
3. **数据持久化**：会话和历史记录保存在服务器，不丢失
4. **团队协作**：未来可扩展团队共享功能

### 3.3 ROI分析

- **投入成本**:
  - 开发工时：7-11周（1.5-2.5个月）× 1人 = 约 50-70 人天
  - 测试和部署：约 10 人天
  - **总投入**：60-80 人天

- **收益量化**：
  - 节省基础设施成本：2000台个人环境 → 1台服务器（节省约 99.95%）
  - 节省IT支持成本：无需为每个用户配置和维护环境（节省约 90% 人力）
  - 安全合规价值：满足企业审计要求（避免合规风险）

- **投资回报周期**:
  - 一次性投入，长期受益
  - 预计 1 个月内回收成本（通过节省的IT支持人力）

- **长期收益**:
  - 可扩展至更多用户（无边际成本）
  - 为团队协作功能打下基础
  - 积累企业级 AI 应用运营经验

### 3.4 风险 vs 收益

**不重构的风险**：
- ❌ 无法满足企业级部署需求
- ❌ 存在严重安全隐患（数据泄露、权限混乱）
- ❌ 无法规模化推广
- ❌ 错失企业 AI 应用机会

**重构的收益**：
- ✅ 满足企业安全合规要求
- ✅ 支持大规模用户并发
- ✅ 降低部署和维护成本
- ✅ 为后续功能扩展奠定基础

---

## 4. 重构方案【核心】

### 4.1 重构策略：渐进式重构 ⭐

**选择理由**：
- 风险可控：每个阶段独立可验证
- 持续交付：不阻塞业务迭代
- 可回滚：每个阶段有独立回滚方案
- 并行开发：可与新功能开发并行

**阶段划分原则**：
1. 基础先行：先建立数据库和认证基础
2. 核心隔离：重点改造 Claude CLI 进程管理
3. 安全加固：最后完善安全和资源管理

### 4.2 重构阶段划分

#### 阶段1: 基础架构改造（1-2周）【P0】

**目标**：建立多用户基础框架

**核心改造**：
1. **数据库迁移**：SQLite → MySQL 8.0 / PostgreSQL 15
   - 设计 `users` 表（用户信息、配额、偏好）
   - 设计 `sessions` 表（添加 `user_id` 字段）
   - 设计 `subscriptions` 表（添加 `user_id` 字段）
   - 设计 `audit_logs` 表（操作审计）

2. **网关认证中间件**（简化方案，无需 LDAP）
   - 实现 `gatewayAuthMiddleware`：
     - 验证静态 Token（Header: `X-Gateway-Token`）
     - 读取用户名 Cookie（`dss_user_name`）
     - 验证用户名格式（防路径注入）
     - 验证用户目录存在
     - 注入 `req.user` 上下文
   - **无需实现**：LDAP 集成、JWT Token 管理、登录接口

3. **用户目录映射服务**
   - 实现 `UserMappingService`：
     - 读取系统用户信息（`getent passwd`）
     - 验证用户目录 `/mnt/bdap/<username>` 存在
     - 返回用户目录映射（HOME、workspace、.claude、.cui）
   - **运维职责**：用户目录由运维团队提前创建和配置权限

4. **用户数据库服务**
   - 实现 `UserService`：
     - 查询用户信息（`getUserByUsername`）
     - 更新用户偏好（`updatePreferences`）
     - 配额管理（`checkQuota`、`incrementQuotaUsage`）

**验收标准**：
- [x] MySQL 数据库表创建成功
- [x] 网关认证中间件正确验证 Token 和 Cookie
- [x] 可以读取系统用户目录映射
- [x] 用户上下文注入到 `req.user`

**影响范围**：新增模块，不影响现有功能

**风险等级**：低

---

#### 阶段2: Claude CLI 多用户改造（2-3周）【P0】

**目标**：实现 Claude CLI 进程和配置的用户隔离

**核心改造**：
1. **ConfigService 多用户化**
   - 从单例模式改为支持多用户配置
   - 新增 `loadUserConfig(username, userCuiDir)` 方法
   - 配置读取路径：`/mnt/bdap/<username>/.cui/config.json`
   - 维护用户配置缓存 Map<username, CUIConfig>

2. **ClaudeProcessManager 进程隔离**（⭐ 核心改造）
   - 修改 `ConversationConfig` 类型，添加 `userContext` 字段：
     ```typescript
     interface MultiUserConversationConfig extends ConversationConfig {
       userContext: {
         username: string;
         homeDir: string;
         workspaceDir: string;
         claudeDir: string;
         cuiDir: string;
       };
     }
     ```
   - **进程启动改造**：使用 `sudo -u <username>` 切换用户
     ```typescript
     // ⭐ 关键：以真实用户身份启动进程
     spawn('sudo', ['-u', username, '-i', '--', 'claude', ...args], {
       cwd: userContext.workspaceDir,
       // sudo -i 自动加载用户环境（HOME=/mnt/bdap/<username>）
     });
     ```
   - **权限隔离机制**：
     - CUI Server 以 `hadoop` 用户运行（超级管理员）
     - 启动 Claude CLI 时切换到真实用户（`zhangsan`、`lisi` 等）
     - 进程的有效用户（euid）= 真实用户
     - 进程只能访问用户自己的文件（Linux 权限控制）

3. **ClaudeHistoryReader 历史隔离**
   - 修改历史读取路径：`/mnt/bdap/<username>/.claude/projects/`
   - 按用户隔离会话历史

4. **SessionInfoService 会话隔离**
   - 会话查询添加 `user_id` 过滤
   - 会话创建记录 `user_id`

**验收标准**：
- [x] 不同用户的 Claude CLI 使用各自的 HOME 目录
- [x] 进程的有效用户（euid）是真实用户，非 hadoop
- [x] 用户 A 无法访问用户 B 的文件
- [x] 会话历史按用户隔离，无交叉污染
- [x] 配置文件正确加载

**影响范围**：核心服务层（ClaudeProcessManager、ConfigService、SessionInfoService）

**风险等级**：中

---

#### 阶段3: 路由和 API 改造（1周）【P0】

**目标**：所有 API 支持网关认证和用户上下文

**核心改造**：
1. **认证中间件应用**
   - 所有 `/api/*` 路由应用 `gatewayAuthMiddleware`
   - 健康检查等公开接口豁免认证

2. **用户路由新增**（新模块）
   - `GET /api/users/me`：获取当前用户信息
   - `PATCH /api/users/me/preferences`：更新用户偏好
   - `GET /api/users/me/quota`：查询配额使用情况

3. **现有路由改造**
   - 对话路由：传递 `req.user.username` 到 ProcessManager
   - 文件系统路由：限制访问范围到用户工作区
   - 流式路由：SSE 连接验证用户身份

4. **SSE 认证处理**
   - 浏览器 `EventSource` 自动携带 Cookie（`dss_user_name`）
   - 企业网关自动注入 `X-Gateway-Token` Header
   - 后端 `gatewayAuthMiddleware` 验证 Token + Cookie

**验收标准**：
- [x] 所有 API 需要认证才能访问
- [x] 未认证请求返回 401
- [x] 用户只能访问自己的资源
- [x] SSE 连接正确认证

**影响范围**：API 路由层

**风险等级**：低

---

#### 阶段4: 安全加固与资源管理（2-3周）【P1】

**目标**：提升系统安全性与稳定性

**核心改造**：
1. **进程生命周期管理**（新增 `ProcessLifecycleManager`）
   - **空闲超时回收**（Idle GC）：
     - 维护每个会话的 `lastActivityTime`
     - 定时扫描（每分钟），超过 10 分钟无交互 → kill 进程
   - **连接断开联动**：
     - 监听 SSE 连接 `close` 事件（前端关闭浏览器）
     - 启动短时倒计时（10分钟），未重连则回收进程
   - **LRU 进程淘汰**：
     - 设置最大并发数（如 100 个进程）
     - 达到上限时，强制回收"最久未活动"的进程
   - **前端心跳机制**：前端每分钟发送心跳请求，防止误回收

2. **用户级日志分流**（新增）
   - Claude CLI 的 `stdout/stderr` 重定向到用户目录
   - 路径：`/mnt/bdap/<username>/.cui/logs/claude-cli-<date>.log`
   - 方便排查特定用户问题

3. **审计日志**（新增 `AuditLogger`）
   - 记录关键操作：启动对话、执行Bash、文件操作
   - 存储到 `audit_logs` 表
   - 包含：用户、操作、资源、时间、IP、结果

4. **速率限制**（新增中间件）
   - 限制单用户 API 请求频率（如 100 req/min）
   - 防止恶意攻击和资源耗尽

5. **文件系统权限验证**
   - 用户目录权限：`drwx------ (700)`
   - 目录所有者：真实用户（`zhangsan:zhangsan`）
   - 配置文件权限：`-rw------- (600)`
   - 编写权限验证脚本

**验收标准**：
- [x] 空闲进程在 10 分钟后自动回收
- [x] 达到最大并发数时，旧进程被正确淘汰
- [x] 前端断开连接后，后端资源及时释放
- [x] 每个用户的日志写入各自目录
- [x] 关键操作有审计日志
- [x] API 有速率限制
- [x] 文件权限正确设置

**影响范围**：安全层、资源管理层

**风险等级**：中

---

#### 阶段5: 前端改造和测试（1-2周）【P1】

**目标**：前端适配多用户体验

**核心改造**：
1. **前端改造**（简化，无需登录页面）
   - **无需实现**：登录页面（网关已完成）
   - **无需实现**：Token 管理（网关处理）
   - **需要实现**：
     - 用户信息展示（显示当前用户名、配额）
     - 配额使用提示（接近上限时警告）
     - 会话列表隔离提示（仅显示当前用户会话）

2. **测试**
   - **单元测试**：
     - `gatewayAuthMiddleware` 测试（Token/Cookie 验证）
     - `UserMappingService` 测试（用户目录读取）
     - `ConfigService` 多用户配置加载测试
   - **集成测试**：
     - 用户隔离验证（用户 A 无法访问用户 B 资源）
     - 进程隔离验证（进程 euid 为真实用户）
     - 会话隔离验证（会话按 user_id 过滤）
   - **压力测试**：
     - 200 并发用户登录测试
     - 500 并发对话测试
   - **安全测试**：
     - 路径注入攻击测试（用户名防注入）
     - 权限越权测试（跨用户访问拦截）

3. **文档**
   - **用户手册**：如何通过网关访问 CUI
   - **管理员手册**：
     - 网关配置说明（Token、Cookie）
     - 用户目录初始化脚本
     - 系统监控指南
   - **API 文档**：更新认证方式说明
   - **故障排查指南**：常见问题和解决方案

**验收标准**：
- [x] 用户通过网关访问系统（无感知登录）
- [x] 测试覆盖率 > 80%
- [x] 文档完善（包括网关集成说明）
- [x] 所有安全测试通过

**影响范围**：前端、测试、文档

**风险等级**：低

---

#### 阶段6: 部署和上线（1周）【P0】

**目标**：生产环境部署并验证

**核心任务**：
1. **生产环境准备**
   - 服务器配置（16-32核心、128GB RAM、500GB SSD）
   - MySQL 数据库部署（8.0+）
   - 环境变量配置（`GATEWAY_TOKEN`、数据库密码）
   - SSL 证书配置

2. **Systemd 服务配置**
   - 以 `hadoop` 用户运行 CUI Server
   - 确保 `hadoop` 有 `NOPASSWD` sudo 权限
   - 配置资源限制（进程数、文件句柄数）

3. **Nginx 反向代理**（可选）
   - HTTPS 配置
   - SSE 连接支持（`proxy_buffering off`）
   - 健康检查端点

4. **监控和告警**
   - 日志监控：journalctl 集成
   - 性能监控：CPU、内存、磁盘
   - 告警配置：资源使用率阈值

5. **数据迁移**（如果有老数据）
   - SQLite → MySQL 数据迁移脚本
   - 数据完整性验证

**验收标准**：
- [x] 系统在生产环境稳定运行
- [x] 监控和告警正常
- [x] 用户可以正常使用
- [x] 性能满足要求（200-500并发）

**影响范围**：部署环境

**风险等级**：中

---

### 4.3 兼容性策略

#### 接口兼容性
- **策略**：保持现有前端 API 接口结构不变
- **方案**：
  - 现有接口增强：添加用户上下文参数，保持响应格式
  - 新增接口：`/api/users/*` 路由（新功能）
- **验证**：前端无需大规模改动，仅需适配认证和用户信息展示

#### 数据兼容性
- **策略**：数据库迁移保留历史数据（如适用）
- **方案**：
  - SQLite → MySQL 迁移脚本
  - 历史会话关联到 `admin` 用户（如需保留）
- **验证**：数据迁移测试

#### 配置兼容性
- **策略**：保留单用户配置格式，扩展为多用户
- **方案**：
  - 单用户配置：`~/.cui/config.json` → 服务器全局配置
  - 多用户配置：`/mnt/bdap/<username>/.cui/config.json`（可选）
- **验证**：配置加载测试

### 4.4 回滚方案

每个阶段必须有独立的回滚方案：

| 阶段 | 回滚方案 | 回滚触发条件 |
|-----|---------|-------------|
| 阶段1 | 恢复 SQLite 数据库，禁用认证中间件 | 数据库迁移失败 |
| 阶段2 | 恢复原 ClaudeProcessManager（不使用 sudo） | 进程隔离故障 |
| 阶段3 | 回滚路由改造，使用原认证方式 | API 集成测试失败 |
| 阶段4 | 禁用进程生命周期管理 | 资源回收异常 |
| 阶段5 | 回滚前端版本 | 前端兼容性问题 |
| 阶段6 | 回滚到上一版本部署 | 生产环境故障 |

**回滚触发条件**：
- 回归测试失败率 > 5%
- 生产环境出现 P0/P1 故障
- 性能下降 > 20%
- 安全审计发现重大漏洞

---

## 5. 风险识别与应对【重要】

### 5.1 风险清单

| 风险ID | 风险描述 | 概率 | 影响 | 应对措施 |
|--------|---------|:----:|:----:|---------|
| R1 | Sudo 权限配置错误导致进程启动失败 | 中 | 高 | 1. 测试环境充分验证 sudo 配置<br>2. 编写自动化验证脚本<br>3. 详细部署文档 |
| R2 | 网关集成问题（Token/Cookie 机制） | 中 | 高 | 1. 与网关团队提前对接<br>2. 模拟网关环境测试<br>3. 降级方案：本地认证 |
| R3 | 用户目录权限配置错误 | 中 | 高 | 1. 编写权限验证脚本<br>2. 运维团队提前培训<br>3. 自动化初始化脚本 |
| R4 | 进程泄露导致资源耗尽 | 中 | 中 | 1. 实施进程生命周期管理<br>2. 设置资源限制（ulimit）<br>3. 监控告警 |
| R5 | 数据库迁移失败或性能瓶颈 | 低 | 高 | 1. 充分测试 SQLite → MySQL 迁移<br>2. 数据库索引优化<br>3. 读写分离（如需要） |
| R6 | 并发压力测试未达标 | 低 | 中 | 1. 提前进行压测<br>2. 性能调优<br>3. 水平扩展方案 |
| R7 | 影响业务正常迭代 | 高 | 中 | 1. 渐进式重构<br>2. 独立分支开发<br>3. 不阻塞业务需求 |
| R8 | 团队不熟悉新架构 | 中 | 中 | 1. 技术分享会<br>2. 详细技术文档<br>3. 代码示例和注释 |

### 5.2 关键风险详细应对

**R1: Sudo 权限配置风险**
- **预防措施**：
  - 编写 `scripts/verify-sudo-config.sh` 脚本，自动验证 sudo 配置
  - 测试环境提前部署并验证
  - 文档详细说明 sudoers 配置步骤
- **应急预案**：
  - 如果 sudo 失败，降级为以 `hadoop` 用户直接启动（牺牲隔离性）
  - 临时方案：使用 Docker 容器隔离

**R2: 网关集成风险**
- **预防措施**：
  - 与企业网关团队提前沟通，确认 Token 和 Cookie 注入机制
  - 开发环境模拟网关（中间件模拟注入）
  - 集成测试覆盖网关场景
- **应急预案**：
  - 降级为本地 JWT Token 认证（阶段1已实现）
  - 延迟网关集成，先上线本地认证版本

**R4: 进程泄露风险**
- **预防措施**：
  - 实施进程生命周期管理（空闲回收、LRU淘汰）
  - 设置系统资源限制（ulimit、cgroups）
  - 监控告警：进程数、内存使用
- **应急预案**：
  - 定时任务强制清理僵尸进程
  - 服务自动重启（systemd Restart=always）

---

## 6. 实施计划【重要】

### 6.1 时间线

| 阶段 | 任务 | 预计时间 | 累计时间 | 风险等级 |
|-----|------|---------|---------|:--------:|
| 阶段1 | 基础架构改造 | 1-2周 | 1-2周 | 低 |
| 阶段2 | Claude CLI 改造 | 2-3周 | 3-5周 | 中 |
| 阶段3 | 路由和 API 改造 | 1周 | 4-6周 | 低 |
| 阶段4 | 安全加固 | 2-3周 | 6-9周 | 中 |
| 阶段5 | 前端和测试 | 1-2周 | 7-11周 | 低 |
| 阶段6 | 部署上线 | 1周 | 8-12周 | 中 |
| **总计** | | **1.5-2.5个月** | | |

### 6.2 里程碑

| 里程碑 | 交付物 | 验收标准 | 计划日期 |
|--------|--------|---------|---------|
| M1 | 数据库和认证基础 | 网关认证中间件通过测试 | 第2周 |
| M2 | 进程隔离 POC | 2个用户进程隔离验证通过 | 第5周 |
| M3 | API 改造完成 | 所有 API 支持用户上下文 | 第6周 |
| M4 | 安全加固完成 | 进程生命周期管理、审计日志测试通过 | 第9周 |
| M5 | 集成测试通过 | 200并发用户测试通过 | 第11周 |
| M6 | 生产环境上线 | 系统稳定运行1周 | 第12周 |

### 6.3 关键路径

```
阶段1（数据库+认证）→ 阶段2（进程隔离）→ 阶段3（API改造）→ 阶段6（部署上线）
                                                    ↓
                                              阶段4（安全加固）
                                                    ↓
                                              阶段5（前端测试）
```

**关键路径说明**：
- 阶段1-2-3-6 是串行依赖，必须按顺序完成
- 阶段4-5 可与阶段3 部分并行
- 总工期受阶段2（进程隔离）影响最大，为关键路径

---

## 7. 验收标准【核心】

### 7.1 功能验收

- [ ] **用户认证**：通过网关 Token + Cookie 认证，验证用户身份
- [ ] **用户隔离**：用户 A 无法访问用户 B 的会话、配置、文件
- [ ] **进程隔离**：Claude CLI 进程的 euid 为真实用户，非 hadoop
- [ ] **配置隔离**：每个用户从 `/mnt/bdap/<username>/.cui/config.json` 加载配置
- [ ] **会话管理**：会话列表按 user_id 过滤，无交叉显示
- [ ] **文件访问**：文件系统操作限制在用户工作区内
- [ ] **配额管理**：用户配额查询和限制生效

### 7.2 性能验收

- [ ] **并发能力**：支持 200-500 并发用户同时使用，响应时间 < 2s
- [ ] **总用户数**：支持 2000 用户总量，数据库查询性能正常
- [ ] **资源管理**：进程总数 < 2000，内存使用 < 100GB
- [ ] **进程回收**：空闲进程在 10 分钟内自动回收

### 7.3 安全验收

- [ ] **权限隔离**：用户目录权限 700，配置文件权限 600
- [ ] **进程权限**：进程以真实用户身份运行（euid 验证）
- [ ] **路径注入防护**：用户名格式验证生效，拒绝 `../` 等攻击
- [ ] **审计日志**：关键操作（启动对话、Bash执行）有审计记录
- [ ] **速率限制**：单用户 API 请求频率限制生效

### 7.4 兼容性验收

- [ ] **API 兼容**：现有前端无需大规模改动即可适配
- [ ] **数据迁移**：历史数据（如适用）完整迁移到 MySQL
- [ ] **配置兼容**：用户配置格式向后兼容

### 7.5 运维验收

- [ ] **监控告警**：CPU、内存、磁盘、进程数监控正常
- [ ] **日志管理**：用户日志分流到各自目录，便于排查
- [ ] **文档完整**：部署文档、运维手册、故障排查指南齐全
- [ ] **回滚验证**：每个阶段回滚方案可执行

---

## 8. 后续改进【参考】

### 8.1 短期优化（3-6个月）

1. **性能优化**
   - 数据库连接池优化
   - Redis 缓存层（用户配置、会话信息）
   - 进程池预热（减少启动延迟）

2. **功能增强**
   - 用户管理后台（管理员界面）
   - 配额自动充值（月度重置）
   - 会话共享功能（团队协作）

3. **监控增强**
   - Prometheus + Grafana 监控面板
   - 分布式追踪（OpenTelemetry）
   - 用户行为分析

### 8.2 长期规划（6-12个月）

1. **高可用架构**
   - 主从数据库（读写分离）
   - 负载均衡（多节点部署）
   - 灰度发布（金丝雀部署）

2. **多租户架构**
   - 组织（Organization）概念
   - 团队工作区（Shared Workspace）
   - 细粒度权限控制（RBAC）

3. **企业集成**
   - SSO 单点登录（SAML/OAuth2）
   - 企业知识库集成
   - CI/CD 流水线集成

### 8.3 技术债务防范

1. **代码规范**
   - 多用户上下文必须通过参数传递，禁止全局变量
   - 数据库查询必须携带 `user_id` 过滤
   - 文件路径必须校验是否在用户工作区内

2. **测试覆盖**
   - 新增功能必须有单元测试
   - 关键路径必须有集成测试
   - 定期进行安全测试

3. **文档维护**
   - 架构变更必须更新文档
   - API 变更必须更新接口文档
   - 定期审查文档时效性

---

## 9. 附录【参考】

### 9.1 技术选型对比

**数据库选型**：

| 方案 | 优点 | 缺点 | 是否采用 |
|-----|------|------|:-------:|
| SQLite | 简单、零配置 | 无法支持多用户并发写入 | ❌ |
| MySQL 8.0 | 成熟、性能好、企业标准 | 需要独立部署 | ✅ |
| PostgreSQL 15 | 功能强大、JSON 支持好 | 学习成本稍高 | 备选 |

**认证方案选型**：

| 方案 | 复杂度 | 企业集成 | 是否采用 |
|-----|-------|---------|:-------:|
| 自研 JWT | 高 | 困难 | ❌ |
| LDAP 直连 | 中 | 中等 | ❌ |
| 网关统一认证 | 低 | 简单 | ✅ |

### 9.2 参考资料

- [Linux 多用户安全模型](https://www.kernel.org/doc/html/latest/security/index.html)
- [MySQL 安全配置](https://dev.mysql.com/doc/refman/8.0/en/security.html)
- [Node.js 进程管理最佳实践](https://nodejs.org/en/docs/guides/simple-profiling/)
- [Linux sudo 安全配置](https://www.sudo.ws/docs/man/sudoers.man/)
- [Express 安全最佳实践](https://expressjs.com/en/advanced/best-practice-security.html)

### 9.3 关键术语

| 术语 | 定义 |
|-----|------|
| **网关统一认证** | 企业统一网关完成用户登录，通过 Header 注入 Token 和 Cookie 传递用户信息 |
| **进程隔离** | 使用 `sudo -u <username>` 切换到真实用户身份运行 Claude CLI，实现进程级隔离 |
| **用户上下文** | `req.user` 对象，包含用户名、HOME 目录、工作区等信息 |
| **配额管理** | 限制单用户每月对话次数，防止资源滥用 |
| **审计日志** | 记录用户关键操作（启动对话、执行命令），满足合规要求 |
| **进程生命周期管理** | 空闲超时回收、连接断开回收、LRU淘汰等机制 |

---

## 10. 文档变更历史

| 版本 | 日期 | 变更说明 | 作者 |
|-----|------|---------|------|
| v1.0 | 2025-12-11 | 初始版本，基于改造计划V2和澄清结果 | Claude Agent |

---

**文档结束**

> 📌 **下一步**：进入第2阶段「重构方案设计」，使用 `des-refactor` Agent 生成详细的技术设计文档。
